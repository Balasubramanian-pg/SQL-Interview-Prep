# SQL Query: Snapchat Activity Breakdown by Age Group

## 1. Objective
> [!NOTE]
> This document explains how to write a SQL query to analyze Snapchat user activity. The goal is to calculate a breakdown of time spent sending vs. opening snaps, expressed as a percentage of the total time spent on these activities, and grouped by the users' age bracket.

## 2. Data Model

### 2.1. `activities` Table
Contains records of user activities, including type and duration.
| Column Name   | Type      |
|:--------------|:----------|
| activity_id   | integer   |
| user_id       | integer   |
| activity_type | string    |
| time_spent    | float     |
| activity_date | datetime  |

### 2.2. `age_breakdown` Table
Contains the age group classification for each user.
| Column Name | Type    |
|:------------|:--------|
| user_id     | integer |
| age_bucket  | string  |

## 3. Core Logic: Percentage Calculation
The primary goal is to compute two percentages for each age group:
1.  **Sending Percentage**: `100.0 * (Total Time Sending) / (Total Time Sending + Total Time Opening)`
2.  **Opening Percentage**: `100.0 * (Total Time Opening) / (Total Time Sending + Total Time Opening)`

> [!IMPORTANT]
> To ensure accurate percentage calculation and avoid integer division, it is crucial to multiply by a decimal value like `100.0` instead of the integer `100`. This forces the database to perform floating-point arithmetic.

## 4. Incremental Query Construction
The solution involves joining the tables, filtering for relevant activities, and then performing a conditional aggregation to calculate the time spent on each activity type per age group.

### 4.1. Step 1: Join Tables and Filter Relevant Activities
First, we join `activities` and `age_breakdown` on `user_id`. We then filter the results to only include the activities we care about: 'send' and 'open'. 'Chat' activities and others are ignored.

```sql
FROM
    activities a
JOIN
    age_breakdown ab ON a.user_id = ab.user_id
WHERE
    a.activity_type IN ('send', 'open')
```

### 4.2. Step 2: Aggregate Time Using Conditional Aggregation
This is the core of the query. Instead of multiple CTEs, we can use a single `GROUP BY` with conditional `SUM` to pivot the data efficiently. For each `age_bucket`, we calculate the total time for 'send' activities and 'open' activities.

```sql
SELECT
    ab.age_bucket,
    -- Sum time_spent only if the activity is 'send'
    SUM(CASE WHEN a.activity_type = 'send' THEN a.time_spent ELSE 0 END) AS send_time,
    -- Sum time_spent only if the activity is 'open'
    SUM(CASE WHEN a.activity_type = 'open' THEN a.time_spent ELSE 0 END) AS open_time
FROM
    -- ... join and filter from Step 1 ...
GROUP BY
    ab.age_bucket;
```
This single step will produce a table with each age group and their total `send_time` and `open_time`.

### 4.3. Step 3: Calculate and Round the Final Percentages
Using the results from the previous step (placed into a CTE), we can now apply our percentage formulas.

> [!CAUTION]
> To prevent a "division by zero" error, it's a best practice to wrap the denominator in a `NULLIF()` function. `NULLIF(expression, 0)` will return `NULL` if the total time is zero, causing the percentage to become `NULL` instead of erroring out.

```sql
SELECT
    age_bucket,
    ROUND(100.0 * send_time / NULLIF(send_time + open_time, 0), 2) AS send_perc,
    ROUND(100.0 * open_time / NULLIF(send_time + open_time, 0), 2) AS open_perc
FROM
    time_totals -- Assumes the query from Step 2 is in a CTE named time_totals
```

## 5. Final Solution
The complete query uses a single CTE to aggregate the time totals, making it efficient and readable.

```sql
WITH time_totals AS (
  -- Step 1 & 2: Join, filter, and aggregate time spent per activity type for each age group.
  SELECT
    ab.age_bucket,
    SUM(CASE WHEN a.activity_type = 'send' THEN a.time_spent ELSE 0 END) AS send_time,
    SUM(CASE WHEN a.activity_type = 'open' THEN a.time_spent ELSE 0 END) AS open_time
  FROM
    activities a
  JOIN
    age_breakdown ab ON a.user_id = ab.user_id
  WHERE
    a.activity_type IN ('send', 'open')
  GROUP BY
    ab.age_bucket
)
-- Step 3: Calculate the final send and open percentages from the aggregated totals.
SELECT
  age_bucket,
  ROUND(100.0 * send_time / NULLIF(send_time + open_time, 0), 2) AS send_perc,
  ROUND(100.0 * open_time / NULLIF(send_time + open_time, 0), 2) AS open_perc
FROM
  time_totals;
```

## 6. Result Analysis

### 6.1. Final Output
| age_bucket | send_perc | open_perc |
|:-----------|:----------|:----------|
| 26-30      | 65.40     | 34.60     |
| 31-35      | 43.75     | 56.25     |

### 6.2. Explanation
*   **For age bucket `26-30`**:
    *   `send_time` = 5.67
    *   `open_time` = 3.00
    *   `total_time` = 8.67
    *   `send_perc` = `ROUND(100.0 * 5.67 / 8.67, 2)` = `65.40`
    *   `open_perc` = `ROUND(100.0 * 3.00 / 8.67, 2)` = `34.60`
*   **For age bucket `31-35`**:
    *   `send_time` = 3.50
    *   `open_time` = 4.50
    *   `total_time` = 8.00
    *   `send_perc` = `ROUND(100.0 * 3.50 / 8.00, 2)` = `43.75`
    *   `open_perc` = `ROUND(100.0 * 4.50 / 8.00, 2)` = `56.25`
