# Year-on-Year Spend Growth Rate

## 1. Objective
> [!NOTE]
> This document explains how to write a SQL query to calculate the year-on-year (YoY) growth rate for the total spend on each product. The output will be grouped by product and will include the current year's spend, the previous year's spend, and the calculated YoY growth percentage.

## 2. Data Model

### 2.1. `user_transactions` Table
Contains individual transaction records for users and products.
| Column Name      | Type     |
|:-----------------|:---------|
| transaction_id   | integer  |
| product_id       | integer  |
| spend            | decimal  |
| transaction_date | datetime |

## 3. Core Concepts

### 3.1. Year-on-Year (YoY) Growth Rate Formula
The YoY growth rate measures the percentage change in a metric between the current year and the previous year.
> **Formula**: `YoY % = ((Current Year Spend - Previous Year Spend) / Previous Year Spend) * 100`

### 3.2. The `LAG()` Window Function
To calculate YoY growth, we need to access the previous year's data on the same row as the current year's data. The `LAG()` window function is the perfect tool for this.
> [!IMPORTANT]
> `LAG(column) OVER (PARTITION BY group ORDER BY sequence)` looks back one row within an ordered sequence.
> - **`PARTITION BY product_id`**: This is crucial. It divides the data into separate "windows" for each product. This ensures that when we look back for the previous year's spend, we are only looking at data for the *same product*.
> - **`ORDER BY year`**: This sorts the data within each product's window chronologically, so `LAG()` correctly fetches the immediately preceding year's value.

## 4. Incremental Query Construction
We will build the solution using a multi-CTE approach to logically separate the steps.

### 4.1. Step 1: Aggregate Total Spend by Year and Product
First, we need to roll up the individual transactions into a total yearly spend for each product.
```sql
-- This query will become our first CTE
SELECT
    EXTRACT(YEAR FROM transaction_date) AS year,
    product_id,
    SUM(spend) AS total_spend
FROM
    user_transactions
GROUP BY
    EXTRACT(YEAR FROM transaction_date), product_id;
```
**Intermediate Result (`yearly_spend`):**
| year | product_id | total_spend |
|:-----|:-----------|:------------|
| 2019 | 123424     | 1500.60     |
| 2020 | 123424     | 1000.20     |
| 2021 | 123424     | 1246.44     |
| 2022 | 123424     | 2145.32     |

### 4.2. Step 2: Fetch the Previous Year's Spend Using `LAG()`
Now that we have the yearly totals, we can use the `LAG()` function to place the previous year's spend alongside the current year's spend.
```sql
-- This query will become our second CTE
SELECT
    year,
    product_id,
    total_spend AS curr_year_spend,
    LAG(total_spend, 1) OVER (
        PARTITION BY product_id
        ORDER BY year
    ) AS prev_year_spend
FROM
    yearly_spend; -- Assumes the query from Step 1 is in this CTE
```
**Intermediate Result (`spend_with_previous`):**
| year | product_id | curr_year_spend | prev_year_spend |
|:-----|:-----------|:----------------|:----------------|
| 2019 | 123424     | 1500.60         | NULL            |
| 2020 | 123424     | 1000.20         | 1500.60         |
| 2021 | 123424     | 1246.44         | 1000.20         |
| 2022 | 123424     | 2145.32         | 1246.44         |

### 4.3. Step 3: Calculate the Final YoY Rate
With both current and previous year's spend on the same row, we can now apply the YoY formula.
> [!CAUTION]
> We must handle the case where `prev_year_spend` is `NULL` (which happens for the first year of data for any product). Attempting to divide by `NULL` would result in `NULL`. A `CASE` statement is used to explicitly return `NULL` for the growth rate in these instances.

## 5. Final Solution
The complete query combines all steps into a clean and readable structure.

```sql
-- CTE 1: Aggregate total spend for each product by year.
WITH yearly_spend AS (
  SELECT
    EXTRACT(YEAR FROM transaction_date) AS year,
    product_id,
    SUM(spend) AS total_spend
  FROM user_transactions
  GROUP BY EXTRACT(YEAR FROM transaction_date), product_id
),
-- CTE 2: Use the LAG() window function to fetch the previous year's spend.
spend_with_previous AS (
  SELECT
    year,
    product_id,
    total_spend AS curr_year_spend,
    LAG(total_spend, 1) OVER (
      PARTITION BY product_id
      ORDER BY year
    ) AS prev_year_spend
  FROM yearly_spend
)
-- Final Query: Calculate the YoY growth rate and format the output.
SELECT
  year,
  product_id,
  curr_year_spend,
  prev_year_spend,
  CASE
    WHEN prev_year_spend IS NULL THEN NULL
    ELSE ROUND(
      ((curr_year_spend - prev_year_spend) / prev_year_spend) * 100.0,
      2
    )
  END AS yoy_rate
FROM spend_with_previous
ORDER BY product_id, year;
```

## 6. Result Analysis

### 6.1. Final Output
| year | product_id | curr_year_spend | prev_year_spend | yoy_rate |
|:-----|:-----------|:----------------|:----------------|:---------|
| 2019 | 123424     | 1500.60         | NULL            | NULL     |
| 2020 | 123424     | 1000.20         | 1500.60         | -33.35   |
| 2021 | 123424     | 1246.44         | 1000.20         | 24.62    |
| 2022 | 123424     | 2145.32         | 1246.44         | 72.12    |

### 6.2. Explanation
*   **For 2021**:
    *   `curr_year_spend` = 1246.44
    *   `prev_year_spend` = 1000.20
    *   `yoy_rate` = `((1246.44 - 1000.20) / 1000.20) * 100.0` = `24.62%`
*   **For 2020**:
    *   `curr_year_spend` = 1000.20
    *   `prev_year_spend` = 1500.60
    *   `yoy_rate` = `((1000.20 - 1500.60) / 1500.60) * 100.0` = `-33.35%`
