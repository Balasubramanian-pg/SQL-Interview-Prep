# Monthly Active Users (MAUs)

> **Date**: 2025-07-30  
> **Difficulty**: Hard

## 1. Problem Statement
Assume you're given a table containing information on Facebook user actions. Write a query to obtain the number of monthly active users (MAUs) in July 2022, including the month in numerical format "1, 2, 3".

> [!IMPORTANT]
> An active user is defined as a user who has performed actions such as 'sign-in', 'like', or 'comment' in **both the current month and the previous month**.

### 1.1. Input Table: `user_actions`

|**Column Name**|**Type**|
|---|---|
|user_id|integer|
|event_id|integer|
|event_type|string ("sign-in, "like", "comment")|
|event_date|datetime|

### 1.2. Example

#### 1.2.1. `user_actions` Example Input:

|user_id|event_id|event_type|event_date|
|---|---|---|---|
|445|7765|sign-in|05/31/2022 12:00:00|
|742|6458|sign-in|06/03/2022 12:00:00|
|445|3634|like|06/05/2022 12:00:00|
|742|1374|comment|06/05/2022 12:00:00|
|648|3124|like|06/18/2022 12:00:00|

#### 1.2.2. Example Output for June 2022:

|month|monthly_active_users|
|---|---|
|6|1|

#### 1.2.3. Explanation

In June 2022, there was only one monthly active user (MAU) with the `user_id` 445 because this user was also active in the previous month (May 2022). User 742 was active in June but not in May.

> [!NOTE]
> The output provided is for June 2022 as the `user_actions` table only contains event dates to illustrate that specific scenario. You should adapt the solution accordingly to find the MAUs for July 2022.

## 2. Solution Approaches
To solve this, we need to find users who were active in both July 2022 AND June 2022. A user is considered a Monthly Active User (MAU) for July 2022 if they performed actions in both months.

### 2.1. Solution 1: Using CTEs and INNER JOIN
This approach logically separates the users from each month before finding the intersection.

```sql
WITH july_users AS (
  SELECT DISTINCT user_id
  FROM user_actions
  WHERE EXTRACT(YEAR FROM event_date) = 2022
    AND EXTRACT(MONTH FROM event_date) = 7
),
june_users AS (
  SELECT DISTINCT user_id
  FROM user_actions
  WHERE EXTRACT(YEAR FROM event_date) = 2022
    AND EXTRACT(MONTH FROM event_date) = 6
)
SELECT
  7 AS month,
  COUNT(july.user_id) AS monthly_active_users
FROM july_users AS july
INNER JOIN june_users AS june
  ON july.user_id = june.user_id;
```

#### 2.1.1. Explanation

> [!TIP]
> Using Common Table Expressions (CTEs) makes the query highly readable. Each CTE acts as a temporary, named result set, allowing you to break down a complex problem into simple, logical steps.

1.  **Step 1: Create CTE `july_users`**: This CTE selects all distinct `user_id`s who had any activity in July 2022. `DISTINCT` is crucial to ensure each user is listed only once, regardless of how many actions they performed.

2.  **Step 2: Create CTE `june_users`**: Similarly, this CTE gets the unique list of users who were active in the previous month, June 2022.

3.  **Step 3: Perform an `INNER JOIN`**: The `INNER JOIN` between the two CTEs on `user_id` is the core of this solution. It creates a result set containing only the users who exist in *both* listsâ€”fulfilling the MAU definition.

4.  **Step 4: Count the Users**: Finally, `COUNT(july.user_id)` counts the number of rows in the joined result, which gives us the total number of monthly active users for July.

### 2.2. Solution 2: Using Subqueries with `IN`
This alternative approach filters the `user_actions` table directly using conditions in subqueries.

```sql
SELECT
  7 AS month,
  COUNT(DISTINCT user_id) AS monthly_active_users
FROM user_actions
WHERE
  -- Condition 1: User must be in the set of users active in July
  user_id IN (
    SELECT user_id
    FROM user_actions
    WHERE EXTRACT(YEAR FROM event_date) = 2022
      AND EXTRACT(MONTH FROM event_date) = 7
  )
  -- Condition 2: User must ALSO be in the set of users active in June
  AND user_id IN (
    SELECT user_id
    FROM user_actions
    WHERE EXTRACT(YEAR FROM event_date) = 2022
      AND EXTRACT(MONTH FROM event_date) = 6
  );
```

#### 2.2.1. Explanation

This query counts distinct users from the main table who satisfy two conditions simultaneously.

1.  **First `IN` Clause**: `user_id IN (...)` checks if a user appears in the list of users who were active in July 2022. The subquery generates this list.

2.  **Second `IN` Clause**: The `AND user_id IN (...)` clause adds a second filter, ensuring the same user also appears in the list of users active in June 2022.

3.  **Final Count**: The `COUNT(DISTINCT user_id)` aggregates the final filtered list to produce the MAU count.

> [!WARNING]
> While functionally correct, using multiple `IN` clauses with subqueries can sometimes be less performant than a `JOIN` on large datasets, as the database might execute separate scans for each subquery. However, modern query optimizers are often smart enough to translate this into an efficient join plan.
