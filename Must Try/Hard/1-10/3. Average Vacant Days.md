# Average Vacant Days for Active Listings

## 1. Problem Statement
The objective is to calculate the average number of vacant days for all *active* property listings within a specific year (e.g., 2021). This requires identifying active listings, calculating the total number of days each was rented, and then determining the vacancy period.

> [!IMPORTANT]
> The core challenge of this problem lies in accurately calculating the number of rented days within the target year, especially for bookings that span across year boundaries (e.g., a booking from December 2020 to January 2021).

## 2. Logical Approach
The problem can be broken down into a sequence of logical steps, which can be translated into a multi-step SQL query using Common Table Expressions (CTEs).

- **1. Identify Active Listings:** First, create a filtered list of all listings marked as `is_active = 1`. This narrows the scope of our analysis to relevant properties only.

- **2. Calculate Rented Days:** For each active listing, determine the total number of days it was booked within the target year. This involves joining with the `bookings` table and handling various date overlap scenarios.

- **3. Calculate Vacant Days:** For each listing, subtract its total rented days from the total number of days in the year (365) to find the number of vacant days.

- **4. Calculate Average Vacant Days:** Finally, compute the average of the vacant days calculated in the previous step across all active listings.

- **5. Handle Edge Cases:** The logic must correctly account for bookings that start before, end after, or completely span the entire year.

> [!NOTE]
> This step-by-step process is ideal for implementation with CTEs in SQL, as each step can be encapsulated in its own CTE, making the final query clean and readable.

## 3. SQL Solution

```sql
WITH ActiveListings AS (
    -- 1. Identify active listings
    SELECT
        listing_id,
        listing_name
    FROM
        listings
    WHERE
        is_active = 1
),
ListingRentedDays AS (
    -- 2. Calculate rented days for each active listing within the specified year (e.g., 2021)
    SELECT
        al.listing_id,
        al.listing_name,
        SUM(
            CASE
                -- Case 1: Booking entirely within the year
                WHEN YEAR(b.check_in_date) = 2021 AND YEAR(b.check_out_date) = 2021
                THEN DATEDIFF(b.check_out_date, b.check_in_date)

                -- Case 2: Booking starts before the year and ends within the year
                WHEN YEAR(b.check_in_date) < 2021 AND YEAR(b.check_out_date) = 2021
                THEN DATEDIFF(b.check_out_date, '2021-01-01')

                -- Case 3: Booking starts within the year and ends after the year
                WHEN YEAR(b.check_in_date) = 2021 AND YEAR(b.check_out_date) > 2021
                THEN DATEDIFF('2021-12-31', b.check_in_date)

                -- Case 4: Booking starts before the year and ends after the year (covers the entire year)
                WHEN YEAR(b.check_in_date) < 2021 AND YEAR(b.check_out_date) > 2021
                THEN 365

                ELSE 0
            END
        ) AS rented_days_2021
    FROM
        ActiveListings al
    LEFT JOIN
        bookings b ON al.listing_id = b.listing_id
    WHERE
        -- Filter bookings relevant to the year 2021 (overlapping in any way)
        b.check_in_date <= '2021-12-31' AND b.check_out_date >= '2021-01-01'
    GROUP BY
        al.listing_id, al.listing_name
),
ListingVacantDays AS (
    -- 3. Calculate vacant days for each listing
    SELECT
        al.listing_id,
        al.listing_name,
        COALESCE(lrd.rented_days_2021, 0) AS rented_days,
        (365 - COALESCE(lrd.rented_days_2021, 0)) AS vacant_days_2021
    FROM
        ActiveListings al
    LEFT JOIN
        ListingRentedDays lrd ON al.listing_id = lrd.listing_id
)
-- 4. Calculate average vacant days across all active listings
SELECT
    AVG(vacant_days_2021) AS average_vacant_days_2021
FROM
    ListingVacantDays;
```

## 4. Code Explanation

### 4.1. CTE 1: `ActiveListings`
This initial CTE simply filters the `listings` table to create a base dataset of all properties that are currently active.

> [!TIP]
> Filtering for active listings at the very beginning is a good practice. It reduces the number of rows processed in subsequent, more complex joins and calculations, improving query performance.

### 4.2. CTE 2: `ListingRentedDays`
This is the most critical part of the query. It calculates the total number of rented days for each active listing within the year 2021.

> [!IMPORTANT]
> The `WHERE b.check_in_date <= '2021-12-31' AND b.check_out_date >= '2021-01-01'` clause is essential. It ensures that we capture *all* bookings that overlap with 2021 in any way, not just those that start and end within the year.

The `CASE` statement inside the `SUM` function handles the four possible scenarios for a booking relative to the year 2021:
1.  **Entirely within 2021:** Calculates the simple difference between check-out and check-in.
2.  **Starts before 2021, ends in 2021:** Calculates days from Jan 1st, 2021, to the check-out date.
3.  **Starts in 2021, ends after 2021:** Calculates days from the check-in date to Dec 31st, 2021.
4.  **Spans the entire year:** The booking covers all 365 days of 2021.

> [!WARNING]
> The `DATEDIFF` function's behavior and argument order can differ between SQL dialects (e.g., MySQL's `DATEDIFF(end, start)` vs. SQL Server's `DATEDIFF(interval, start, end)`). The provided syntax assumes a MySQL-like implementation.

> [!CAUTION]
> The query hardcodes `365` days for the year. This is a simplification and would be incorrect for a leap year (like 2020 or 2024). A more robust solution would dynamically check if the target year is a leap year.

### 4.3. CTE 3: `ListingVacantDays`
This CTE calculates the final number of vacant days for every active listing.

> [!TIP]
> A `LEFT JOIN` is used from `ActiveListings` to `ListingRentedDays` to ensure that even active listings with *zero* bookings in 2021 are included in the final calculation. Without a `LEFT JOIN`, these listings would be dropped.

The `COALESCE(lrd.rented_days_2021, 0)` function is used to handle the `NULL` values that result from the `LEFT JOIN` for listings with no bookings. It converts `NULL` to `0`, allowing the subtraction `(365 - 0)` to execute without errors.

### 4.4. Final Query
The final `SELECT` statement performs a simple aggregation on the results from the `ListingVacantDays` CTE.

> [!NOTE]
> The `AVG(vacant_days_2021)` function calculates the mean of the `vacant_days_2021` column, providing the single-value answer required by the problem statement.
