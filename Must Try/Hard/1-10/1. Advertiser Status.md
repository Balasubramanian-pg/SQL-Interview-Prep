# 1. Advertiser Status Update

## 1. Objective
> [!NOTE]
> This document outlines the process for writing a SQL query to update the payment status of advertisers. The query will classify each advertiser as 'NEW', 'EXISTING', 'CHURN', or 'RESURRECT' based on their current status and recent payment activity.

## 2. Data Model

### 2.1. `advertiser` Table
This table contains the current status of each advertiser.
*   **`user_id`** (string): The unique identifier for the advertiser.
*   **`status`** (string): The advertiser's current status (e.g., 'NEW', 'EXISTING').

**Example Data:**
| user_id | status   |
| :------ | :------- |
| bing    | NEW      |
| yahoo   | NEW      |
| alibaba | EXISTING |

### 2.2. `daily_pay` Table
This table contains payment information and only includes advertisers who have made a payment on the given day.
*   **`user_id`** (string): The unique identifier for the advertiser.
*   **`paid`** (decimal): The amount paid.

**Example Data:**
| user_id | paid   |
| :------ | :----- |
| yahoo   | 45.00  |
| alibaba | 100.00 |
| target  | 13.00  |

> [!TIP]
> The `daily_pay` table acts as a transactional log for a specific day. Its key feature is that the *presence* of a `user_id` signifies a payment was made.

## 3. Understanding the Status Transition Logic
The core of the problem is to apply a set of rules to determine the `new_status`.

### 3.1. Status Transition Table
| # | Current Status | Updated Status | Payment on Day T |
|:-:|:---------------|:---------------|:-----------------|
| 1 | NEW            | EXISTING       | Paid             |
| 2 | NEW            | CHURN          | Not paid         |
| 3 | EXISTING       | EXISTING       | Paid             |
| 4 | EXISTING       | CHURN          | Not paid         |
| 5 | CHURN          | RESURRECT      | Paid             |
| 6 | CHURN          | CHURN          | Not paid         |
| 7 | RESURRECT      | EXISTING       | Paid             |
| 8 | RESURRECT      | CHURN          | Not paid         |

### 3.2. Simplified Logic Rules
The table can be summarized into two main scenarios:

> [!IMPORTANT]
> 1.  **If an advertiser did NOT make a payment:** Their new status is always **`CHURN`**, regardless of their previous status.
> 2.  **If an advertiser DID make a payment:**
>     *   If their previous status was `CHURN`, their new status becomes **`RESURRECT`**.
>     *   For any other previous status (`NEW`, `EXISTING`, `RESURRECT`), their new status becomes **`EXISTING`**.

## 4. Incremental Query Construction
We will build the query step-by-step to implement the logic.

### 4.1. Step 1: Combine Advertiser and Payment Data
To know which advertisers paid, we must join the `advertiser` table with the `daily_pay` table.

> [!TIP]
> A `LEFT JOIN` is the correct choice here. We start with the `advertiser` table (`FROM advertiser a`) and join payment data to it. This ensures that *all* advertisers are included in our result, even if they have no matching record in `daily_pay`.

```sql
SELECT
    a.user_id,
    a.status AS current_status,
    dp.user_id AS paid_user_id
FROM
    advertiser a
LEFT JOIN
    daily_pay dp ON a.user_id = dp.user_id;
```
**Intermediate Result:**
| user_id | current_status | paid_user_id |
| :------ | :------------- | :----------- |
| bing    | NEW            | NULL         |
| yahoo   | NEW            | yahoo        |
| alibaba | EXISTING       | alibaba      |

> [!NOTE]
> Notice that `paid_user_id` is `NULL` for "bing". This is the key indicator that "bing" did not make a payment.

> [!WARNING]
> Using an `INNER JOIN` here would be incorrect. It would filter out "bing" entirely, and we would lose the ability to update their status to 'CHURN'.

### 4.2. Step 2: Apply Conditional Logic with `CASE`
Now we translate our simplified logic rules into a `CASE` statement based on the joined data.

#### 4.2.1. Handling Non-Payers
The first and simplest rule is to identify advertisers who did not pay. We check if the `user_id` from the `daily_pay` table is `NULL`.

```sql
CASE
    WHEN dp.user_id IS NULL THEN 'CHURN'
    ...
END
```

#### 4.2.2. Handling Payers
If `dp.user_id` is NOT `NULL`, the advertiser paid. Now we must check their previous status from the `advertiser` table (`a.status`).

> [!CAUTION]
> The order of conditions in a `CASE` statement matters. The first condition that evaluates to true is the one that is executed. Always handle the most specific or overriding conditions first.

The rule states that if the previous status was `CHURN`, the new status is `RESURRECT`.

```sql
CASE
    WHEN dp.user_id IS NULL THEN 'CHURN'
    WHEN a.status = 'CHURN' THEN 'RESURRECT' -- This implicitly means they also paid
    ...
END
```

#### 4.2.3. Handling All Other Payers
If an advertiser paid but their status was not `CHURN`, their new status is `EXISTING`. This becomes our `ELSE` condition.

```sql
CASE
    WHEN dp.user_id IS NULL THEN 'CHURN'
    WHEN a.status = 'CHURN' THEN 'RESURRECT'
    ELSE 'EXISTING'
END AS new_status
```

### 4.3. Step 3: Add Sorting
The final requirement is to sort the output by `user_id`. We add an `ORDER BY` clause.

```sql
ORDER BY a.user_id;
```

## 5. Final Solution
Combining all the steps gives us the complete and correct query.

```sql
SELECT
  a.user_id,
  CASE
    WHEN dp.user_id IS NULL THEN 'CHURN'      -- Rule 1: No payment made, status is CHURN.
    WHEN a.status = 'CHURN' THEN 'RESURRECT'  -- Rule 2a: Was churned, now paid -> RESURRECT.
    ELSE 'EXISTING'                           -- Rule 2b: Any other status and paid -> EXISTING.
  END AS new_status
FROM
  advertiser a
LEFT JOIN
  daily_pay dp ON a.user_id = dp.user_id
ORDER BY
  a.user_id;
```

## 6. Result Verification
Running this query against the sample data produces the desired output.

### 6.1. Example Output:
| user_id | new_status |
| :------ | :--------- |
| alibaba | EXISTING   |
| bing    | CHURN      |
| yahoo   | EXISTING   |

### 6.2. Explanation:
*   **alibaba**: Was `EXISTING` and made a payment. The `ELSE` condition applies, resulting in `EXISTING`.
*   **bing**: Was `NEW` but did not make a payment (`dp.user_id IS NULL`). The first `WHEN` condition applies, resulting in `CHURN`.
*   **yahoo**: Was `NEW` and made a payment. The `ELSE` condition applies, resulting in `EXISTING`.
