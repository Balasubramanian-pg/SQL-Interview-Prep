# Total Drug Sales by Manufacturer

## 1. Problem Statement

### 1.1. Objective
CVS Health wants to gain a clearer understanding of its pharmacy sales and the performance of various products at the manufacturer level.

Write a query to calculate the total drug sales for each manufacturer. Round the answer to the nearest million and report your results in descending order of total sales. In case of any ties in sales, sort them alphabetically by the manufacturer name.

> [!IMPORTANT]
> The final output requires specific string formatting. The results should be displayed as, for example, **"$36 million"**.

### 1.2. Input Table: `pharmacy_sales`

#### 1.2.1. Schema
|**Column Name**|**Type**|
|---|---|
|product_id|integer|
|units_sold|integer|
|total_sales|decimal|
|cogs|decimal|
|manufacturer|varchar|
|drug|varchar|

> [!NOTE]
> The input table contains data for individual drugs. The first step of the analysis will be to aggregate this data up to the manufacturer level.

#### 1.2.2. Example Input
|**product_id**|**total_sales**|**manufacturer**|**drug**|
|---|---|---|---|
|94|2041758.41|Biogen|UP and UP|
|9|293452.54|Eli Lilly|Zyprexa|
|50|2521023.73|Eli Lilly|Dermasorb|
|61|500101.61|Biogen|Varicose Relief|
|136|1084258.00|Biogen|Burkhart|

### 1.3. Example Output & Explanation

#### 1.3.1. Example Output
|**manufacturer**|**sale**|
|---|---|
|Biogen|$4 million|
|Eli Lilly|$3 million|

#### 1.3.2. Explanation
-   **Biogen**: Total sales are `$2,041,758.41 + $500,101.61 + $1,084,258.00 = $3,626,118.02`. Rounded to the nearest million, this is $4 million.
-   **Eli Lilly**: Total sales are `$293,452.54 + $2,521,023.73 = $2,814,476.27`. Rounded to the nearest million, this is $3 million.

## 2. Conceptual Approach
To solve this, we need to aggregate the sales data for each manufacturer, perform a rounding calculation, and then format the result into a specific string format.

1.  **Group by Manufacturer**: First, group all rows in the `pharmacy_sales` table by the `manufacturer` column.
2.  **Sum Total Sales**: For each manufacturer group, calculate the sum of the `total_sales`.
3.  **Round to Nearest Million**: Divide the total sales sum by 1,000,000 and then round the result to the nearest whole number.
4.  **Format as String**: Concatenate the rounded number with a dollar sign prefix and a " million" suffix to match the required output format.
5.  **Order the Results**: Sort the final output first by the total sales amount (descending) and then by the manufacturer's name (ascending) to handle ties.

> [!TIP]
> The logical flow is: **Aggregate -> Calculate -> Format -> Order**. Breaking the problem down this way makes it easier to write the SQL query step-by-step.

## 3. SQL Solution

```sql
SELECT
  manufacturer,
  '$' || ROUND(SUM(total_sales) / 1000000.0)::TEXT || ' million' AS sale
FROM
  pharmacy_sales
GROUP BY
  manufacturer
ORDER BY
  SUM(total_sales) DESC,
  manufacturer ASC;
```

## 4. Code Breakdown

### 4.1. The `GROUP BY` Clause
-   `GROUP BY manufacturer`: This clause is essential. It groups all rows for a given manufacturer (e.g., all 'Biogen' drugs) into a single "bucket" so that aggregate functions like `SUM()` can be applied to them.

### 4.2. The `SELECT` Clause & Formatting
This is the most complex part of the query, involving calculation, rounding, and string formatting.

-   `SUM(total_sales)`: This aggregate function calculates the total sales for each manufacturer group.
-   `/ 1000000.0`: The sum is divided by one million to scale the number down.

> [!WARNING]
> Using a floating-point number like `1000000.0` instead of an integer `1000000` is a safe practice to prevent integer division, which can truncate decimal results in some SQL dialects.

-   `ROUND(...)`: This function takes the scaled sales number and rounds it to the nearest whole number (e.g., 3.62 becomes 4).
-   `::TEXT`: This is PostgreSQL syntax for casting the rounded number to a text (string) data type. In other dialects, you might use `CAST(... AS VARCHAR)`.
-   `'$' || ... || ' million'`: This performs string concatenation to build the final output format. The `||` operator is standard in SQL and PostgreSQL for concatenating strings.

> [!CAUTION]
> The string concatenation operator varies by SQL dialect. SQL Server uses the `+` operator, while MySQL uses the `CONCAT()` function.

### 4.3. The `ORDER BY` Clause
-   `ORDER BY SUM(total_sales) DESC, manufacturer ASC`: This clause sorts the final results according to two criteria.
-   `SUM(total_sales) DESC`: This is the primary sort condition. It orders the manufacturers from the highest total sales to the lowest.

> [!IMPORTANT]
> It is crucial to sort by the *actual numeric sum*, `SUM(total_sales)`, and not by the final formatted string alias (`sale`). Sorting alphabetically on a string like `'$4 million'` would produce an incorrect order (e.g., '$10 million' would come before '$4 million').

-   `manufacturer ASC`: This is the secondary sort condition. It acts as a tie-breaker. If two manufacturers have the exact same total sales, they will be sorted alphabetically by name.

> [!NOTE]
> This query effectively transforms raw numeric data into a formatted, business-friendly report, which is a common task for data analysts.
