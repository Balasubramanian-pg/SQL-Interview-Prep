# Top 3 Profitable Drugs

## 1. Problem Statement

### 1.1. Objective
CVS Health is trying to better understand its pharmacy sales and how well different products are selling.

Write a query to find the **top 3 most profitable drugs** sold and how much profit they made. Assume that there are no ties in the profits. Display the result from the highest to the lowest total profit.

### 1.2. Definition
-   `cogs` stands for Cost of Goods Sold, which is the direct cost associated with producing the drug.

> [!IMPORTANT]
> The profit calculation is a simple row-wise subtraction: `Total Profit = Total Sales - Cost of Goods Sold`. No complex aggregation is needed as each row represents a distinct drug's performance.

### 1.3. Input Table: `pharmacy_sales`

#### 1.3.1. Schema
|**Column Name**|**Type**|
|---|---|
|product_id|integer|
|units_sold|integer|
|total_sales|decimal|
|cogs|decimal|
|manufacturer|varchar|
|drug|varchar|

> [[!NOTE]
> The input table is already aggregated at the `product_id` and `drug` level, which simplifies the profit calculation significantly.

#### 1.3.2. Example Input
|**product_id**|**units_sold**|**total_sales**|**cogs**|**manufacturer**|**drug**|
|---|---|---|---|---|---|
|9|37410|293452.54|208876.01|Eli Lilly|Zyprexa|
|34|94698|600997.19|521182.16|AstraZeneca|Surmontil|
|61|77023|500101.61|419174.97|Biogen|Varicose Relief|
|136|144814|1084258|1006447.73|Biogen|Burkhart|

### 1.4. Example Output & Explanation

#### 1.4.1. Example Output
|**drug**|**total_profit**|
|---|---|
|Zyprexa|84576.53|
|Varicose Relief|80926.64|
|Surmontil|79815.03|

#### 1.4.2. Explanation
-   **Zyprexa**: `$293,452.54 (sales) - $208,876.01 (cogs) = $84,576.53 (profit)`
-   **Varicose Relief**: `$500,101.61 (sales) - $419,174.97 (cogs) = $80,926.64 (profit)`
-   **Surmontil**: `$600,997.19 (sales) - $521,182.16 (cogs) = $79,815.03 (profit)`

> [!TIP]
> The final output is sorted by the calculated `total_profit` in descending order to show the most profitable drugs first.

## 2. Conceptual Approach
The problem requires a straightforward calculation, ordering, and limiting of the results.

1.  **Calculate Profit**: For each row in the `pharmacy_sales` table, calculate the profit by subtracting `cogs` from `total_sales`.
2.  **Order by Profit**: Sort the entire table in descending order based on the calculated profit.
3.  **Select Top 3**: Limit the final output to the first three rows of the sorted result set.

> [!NOTE]
> Since each row in the table represents a unique drug, we do not need to use a `GROUP BY` clause. The profit calculation can be performed directly on each row.

## 3. SQL Solution
To find the top 3 most profitable drugs sold and their total profit, you can use the following SQL query:

```sql
SELECT
    drug,
    total_sales - cogs AS total_profit
FROM pharmacy_sales
ORDER BY total_profit DESC
LIMIT 3;
```

> [!CAUTION]
> If `total_sales` or `cogs` could be `NULL`, it would be wise to use `COALESCE` (e.g., `COALESCE(total_sales, 0) - COALESCE(cogs, 0)`) to avoid the entire profit calculation resulting in `NULL`.

## 4. Code Breakdown

### 4.1. The `SELECT` Clause
-   `drug`: This selects the name of the drug.
-   `total_sales - cogs AS total_profit`: This performs the profit calculation for each row and assigns the result to a new column named `total_profit`.

> [!TIP]
> Using an alias like `AS total_profit` makes the query more readable and allows you to reference the calculated column in the `ORDER BY` clause, which is a convenient feature in many SQL dialects.

### 4.2. The `ORDER BY` Clause
-   `ORDER BY total_profit DESC`: This clause sorts the result set based on our calculated `total_profit` column. The `DESC` keyword specifies a descending order, so the highest profit appears first.

> [!WARNING]
> Not all SQL dialects allow you to use a column alias in the `ORDER BY` clause. In such cases, you would have to repeat the calculation: `ORDER BY (total_sales - cogs) DESC`.

### 4.3. The `LIMIT` Clause
-   `LIMIT 3`: This clause restricts the output to the top 3 rows *after* the `ORDER BY` clause has been applied.

> [!IMPORTANT]
> The `LIMIT` clause is specific to databases like PostgreSQL and MySQL. The equivalent in SQL Server is the `TOP` keyword: `SELECT TOP 3 drug, ...`. The `ORDER BY` is essential for `LIMIT` or `TOP` to return the correct "top N" results.
