# Monthly Average Product Ratings

## 1. Problem Statement

### 1.1. Objective
Given a `reviews` table, write a query to retrieve the average star rating for each product, grouped by month. The output should display the month as a numerical value, the product ID, and the average star rating rounded to two decimal places. The output should be sorted first by month and then by product ID.

> [!IMPORTANT]
> The core task is a two-level aggregation: you must group the data by both the month of the review and the specific product being reviewed to calculate the correct average for each combination.

### 1.2. Input Table: `reviews`

#### 1.2.1. Schema
|**Column Name**|**Type**|
|---|---|
|review_id|integer|
|user_id|integer|
|submit_date|datetime|
|product_id|integer|
|stars|integer (1-5)|

> [!NOTE]
> The `stars` column contains integer values from 1 to 5, which will be used in the `AVG()` calculation.

#### 1.2.2. Example Input
|**review_id**|**user_id**|**submit_date**|**product_id**|**stars**|
|---|---|---|---|---|
|6171|123|06/08/2022 00:00:00|50001|4|
|7802|265|06/10/2022 00:00:00|69852|4|
|5293|362|06/18/2022 00:00:00|50001|3|
|6352|192|07/26/2022 00:00:00|69852|3|
|4517|981|07/05/2022 00:00:00|69852|2|

### 1.3. Example Output & Explanation

#### 1.3.1. Example Output
|**mth**|**product**|**avg_stars**|
|---|---|---|
|6|50001|3.50|
|6|69852|4.00|
|7|69852|2.50|

#### 1.3.2. Explanation
-   Product `50001` received two ratings in June (month 6): one with 4 stars and one with 3 stars. The average is `(4 + 3) / 2 = 3.50`.
-   Product `69852` received one rating of 4 stars in June, for an average of `4.00`.
-   Product `69852` received two ratings in July (month 7): one with 3 stars and one with 2 stars. The average is `(3 + 2) / 2 = 2.50`.

## 2. Conceptual Approach
To achieve the desired output, the query needs to perform several standard SQL operations in a specific order.

1.  **Extract the Month**: Isolate the month number from the `submit_date` column.
2.  **Group Data**: Group the rows of the `reviews` table based on two criteria: the extracted month and the `product_id`.
3.  **Calculate the Average**: For each of these groups, calculate the average of the `stars` column.
4.  **Format the Output**: Round the calculated average to two decimal places and use aliases for the columns as required.
5.  **Sort the Results**: Order the final output first by month and then by product ID.

> [!TIP]
> The `GROUP BY` clause is the engine of this query. By grouping by both month and product, you create the specific "buckets" (e.g., "June-Product50001", "July-Product69852") over which the `AVG()` function will operate.

## 3. SQL Solutions
The exact syntax for extracting the month from a date can vary between different SQL database systems. Below are solutions for several common dialects.

### 3.1. Standard SQL / PostgreSQL

```sql
SELECT
    EXTRACT(MONTH FROM submit_date) AS mth,
    product_id AS product,
    ROUND(AVG(stars), 2) AS avg_stars
FROM
    reviews
GROUP BY
    EXTRACT(MONTH FROM submit_date),
    product_id
ORDER BY
    mth,
    product;
```

### 3.2. MySQL

```sql
SELECT
    MONTH(submit_date) AS mth,
    product_id AS product,
    ROUND(AVG(stars), 2) AS avg_stars
FROM
    reviews
GROUP BY
    MONTH(submit_date),
    product_id
ORDER BY
    mth,
    product;
```

### 3.3. SQL Server

```sql
SELECT
    DATEPART(MONTH, submit_date) AS mth,
    product_id AS product,
    ROUND(AVG(stars * 1.0), 2) AS avg_stars
FROM
    reviews
GROUP BY
    DATEPART(MONTH, submit_date),
    product_id
ORDER BY
    mth,
    product;
```

> [!WARNING]
> In some database systems like SQL Server, the `AVG()` function on an integer column might return an integer. Multiplying by `1.0` (e.g., `AVG(stars * 1.0)`) is a common trick to force a floating-point calculation, ensuring the decimal places are preserved before rounding.

## 4. Code Breakdown (Standard SQL)

### 4.1. The `SELECT` Clause
-   `EXTRACT(MONTH FROM submit_date) AS mth`: This function extracts the numerical value for the month (1-12) from the `submit_date` column. It is aliased as `mth`.
-   `product_id AS product`: The product identifier is selected and aliased as `product`.
-   `ROUND(AVG(stars), 2) AS avg_stars`: This is a nested function call.
    -   `AVG(stars)`: First, the average of the `stars` column is calculated for each group defined by the `GROUP BY` clause.
    -   `ROUND(..., 2)`: Then, this average value is rounded to two decimal places. The result is aliased as `avg_stars`.

### 4.2. The `GROUP BY` Clause
-   `GROUP BY EXTRACT(MONTH FROM submit_date), product_id`: This clause instructs the database to group rows that have the same month and the same `product_id` together. The `AVG()` function will then be applied to each of these distinct groups.

> [!IMPORTANT]
> A fundamental rule of `GROUP BY` is that any non-aggregated column in the `SELECT` list must also appear in the `GROUP BY` clause. Here, `EXTRACT(MONTH FROM submit_date)` and `product_id` are the non-aggregated columns.

### 4.3. The `ORDER BY` Clause
-   `ORDER BY mth, product`: This clause sorts the final result set.
-   It first sorts the rows by the month (`mth`) in ascending order.
-   For rows that have the same month, it then applies a secondary sort by the product ID (`product`), also in ascending order. This ensures a consistent and readable output.

> [!CAUTION]
> The `ORDER BY` clause is for presentation and does not affect the calculation itself. Omitting it would produce a correctly calculated but potentially unordered result set.
