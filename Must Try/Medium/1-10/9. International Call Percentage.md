# International Calls Percentage

## 1. Problem Statement

### 1.1. Objective
A phone call is considered an international call when the person calling is in a different country than the person receiving the call.

Write a query to calculate what percentage of phone calls are international. The final result should be rounded to 1 decimal place.

> [!IMPORTANT]
> The definition of an international call is the core of this problem: `caller_country_id <> receiver_country_id`. The main challenge is retrieving both countries for each call record.

### 1.2. Assumption
-   The `caller_id` in the `phone_info` table is a unique user identifier and refers to both callers and receivers.

> [!NOTE]
> This assumption is critical. It means the `phone_info` table acts as a master directory for all phone users, and we can look up any user's details (like their country) using their ID, regardless of whether they are making or receiving a call.

### 1.3. Input Schemas

#### 1.3.1. `phone_calls` Table:

|Column Name|Type|
|---|---|
|caller_id|integer|
|receiver_id|integer|
|call_time|timestamp|

#### 1.3.2. `phone_info` Table:

|Column Name|Type|
|---|---|
|caller_id|integer|
|country_id|integer|
|network|integer|
|phone_number|string|

### 1.4. Example

#### 1.4.1. Example Input & Explanation:

`phone_calls` Input:
|caller_id|receiver_id|call_time|
|---|---|---|
|1|2|2022-07-04 10:13:49|
|1|5|2022-08-21 23:54:56|
|5|1|2022-05-13 17:24:06|
|5|6|2022-03-18 12:11:49|

`phone_info` Input:
|caller_id|country_id|
|---|---|
|1|US|
|2|US|
|5|IN|
|6|IN|

**Analysis:**
-   Call 1 (`US`) → 2 (`US`): Domestic
-   Call 1 (`US`) → 5 (`IN`): **International**
-   Call 5 (`IN`) → 1 (`US`): **International**
-   Call 5 (`IN`) → 6 (`IN`): Domestic

There is a total of 4 calls, with 2 of them being international. Thus, the percentage is `2 / 4 = 50.0%`.

#### 1.4.2. Example Output:

|international_calls_pct|
|---|
|50.0|

## 2. Conceptual Approach
To solve this, we need to enrich each record in the `phone_calls` table with the country information for both the caller and the receiver.

1.  **Get Caller and Receiver Countries**: For each call, we need to look up the caller's country and the receiver's country. Since this information is in the `phone_info` table, we will need to join to it twice.
2.  **Identify International Calls**: Once we have both countries on the same row, we can compare them. If the countries are different, the call is international.
3.  **Calculate the Percentage**: The final percentage is the ratio of the count of international calls to the total count of all calls, multiplied by 100.

> [!TIP]
> The key to this problem is a "double self-join" pattern. We join the `phone_calls` table to the `phone_info` table twice on the same query: once to get the caller's details and a second time to get the receiver's details.

## 3. SQL Solution

```sql
SELECT
  ROUND(
    100.0 * SUM(
      CASE
        WHEN caller_info.country_id != receiver_info.country_id THEN 1
        ELSE 0
      END
    ) / COUNT(*),
    1
  ) AS international_calls_pct
FROM phone_calls AS pc
INNER JOIN phone_info AS caller_info
  ON pc.caller_id = caller_info.caller_id
INNER JOIN phone_info AS receiver_info
  ON pc.receiver_id = receiver_info.caller_id;
```

## 4. Code Breakdown

### 4.1. The Double `JOIN`
The core of this query is joining the `phone_info` table twice to get details for two different entities (caller and receiver) from the same source table.
-   `INNER JOIN phone_info AS caller_info ON pc.caller_id = caller_info.caller_id`: This first join links each call to the caller's information. We alias `phone_info` as `caller_info` for clarity.
-   `INNER JOIN phone_info AS receiver_info ON pc.receiver_id = receiver_info.caller_id`: This second join links the same call to the receiver's information. We use a different alias, `receiver_info`, to distinguish it from the first join.

> [!NOTE]
> Using descriptive aliases like `caller_info` and `receiver_info` is crucial for readability and preventing ambiguity when a table is joined to itself or used multiple times.

### 4.2. Conditional Aggregation
This pattern is used to count the number of international calls (the numerator).
-   `CASE WHEN caller_info.country_id != receiver_info.country_id THEN 1 ELSE 0 END`: This expression acts as a flag. It returns `1` if the call is international and `0` if it is domestic.
-   `SUM(...)`: By summing these flags, we get the total count of international calls.

> [!IMPORTANT]
> The `SUM(CASE ...)` pattern is a standard and highly efficient way to count rows that meet a specific condition. It is more flexible than `COUNT(CASE ...)` because it allows for more complex scoring if needed, and it performs the entire aggregation in a single pass.

### 4.3. The Percentage Calculation
The query calculates the final percentage using the results of the aggregation.
-   The denominator, `COUNT(*)`, gives the total number of rows after the joins, which represents the total number of valid calls.
-   The ratio `SUM(...) / COUNT(*)` gives the proportion of international calls.

> [!CAUTION]
> Multiplying by `100.0` instead of `100` is a critical detail. It forces the database to perform floating-point division, which preserves the decimal places. If we used `100`, many SQL dialects would perform integer division, which would likely result in an incorrect answer of `0`.

### 4.4. Final Formatting
-   `ROUND(..., 1)`: This function takes the final calculated percentage and rounds it to one decimal place, as required by the problem statement.
