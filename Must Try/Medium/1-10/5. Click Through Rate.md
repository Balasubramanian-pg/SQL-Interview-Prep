# App Click-Through Rate (CTR)

## 1. Objective
> [!NOTE]
> This document explains how to write a SQL query to calculate the click-through rate (CTR) for each app in the year 2022. The final result will be rounded to two decimal places.

## 2. Data Model

### 2.1. `events` Table
Contains app analytics data, recording each user interaction as an event.
| Column Name | Type      |
|:------------|:----------|
| app_id      | integer   |
| event_type  | string    |
| timestamp   | datetime  |

### 2.2. Example Data
| app_id | event_type | timestamp           |
|:-------|:-----------|:--------------------|
| 123    | impression | 07/18/2022 11:36:12 |
| 123    | impression | 07/18/2022 11:37:12 |
| 123    | click      | 07/18/2022 11:37:42 |
| 234    | impression | 07/18/2022 14:15:12 |
| 234    | click      | 07/18/2022 14:16:12 |

## 3. Click-Through Rate (CTR) Definition
The CTR is the ratio of clicks to impressions, expressed as a percentage.

> **Formula**: `CTR % = 100.0 * (Number of Clicks / Number of Impressions)`

> [!CAUTION]
> It is crucial to multiply by a decimal value like `100.0` instead of an integer `100`. This forces the database to perform floating-point division, preventing integer division which would truncate the decimal part of the ratio (e.g., `1 / 2` would result in `0` instead of `0.5`).

## 4. Incremental Query Construction
We will build the query step-by-step to calculate the CTR for each app.

### 4.1. Step 1: Filter Events for the Year 2022
First, we must isolate the data to the relevant time period.

```sql
SELECT
    *
FROM
    events
WHERE
    timestamp >= '2022-01-01' AND timestamp < '2023-01-01';
```
> [!TIP]
> This date range filtering method (`>= start_date AND < end_date + 1`) is a best practice. It is SARGable, meaning the database can efficiently use an index on the `timestamp` column, and it correctly handles timestamps with time components.

### 4.2. Step 2: Count Clicks and Impressions per App
Next, we need to aggregate the data for each `app_id` and count the occurrences of 'click' and 'impression' events. This is a perfect use case for conditional aggregation.

> [!IMPORTANT]
> Conditional aggregation uses a `CASE` statement inside an aggregate function (like `SUM` or `COUNT`) to count only the rows that meet a specific condition.

```sql
SELECT
    app_id,
    SUM(CASE WHEN event_type = 'click' THEN 1 ELSE 0 END) AS click_count,
    SUM(CASE WHEN event_type = 'impression' THEN 1 ELSE 0 END) AS impression_count
FROM
    events
WHERE
    timestamp >= '2022-01-01' AND timestamp < '2023-01-01'
GROUP BY
    app_id;
```
**Intermediate Result:**
| app_id | click_count | impression_count |
|:-------|:------------|:-----------------|
| 123    | 1           | 2                |
| 234    | 1           | 1                |

### 4.3. Step 3: Calculate CTR and Handle Division by Zero
Now we can apply the CTR formula using the aggregated counts from the previous step.

> [!WARNING]
> A common error in this calculation is division by zero, which occurs if an app has clicks but zero impressions. To prevent this, we use the `NULLIF(denominator, 0)` function. `NULLIF` returns `NULL` if its two arguments are equal; otherwise, it returns the first argument. Dividing by `NULL` results in `NULL`, gracefully avoiding an error.

```sql
SELECT
    app_id,
    100.0 *
        SUM(CASE WHEN event_type = 'click' THEN 1 ELSE 0 END) /
        NULLIF(SUM(CASE WHEN event_type = 'impression' THEN 1 ELSE 0 END), 0) AS ctr
FROM
    events
WHERE
    timestamp >= '2022-01-01' AND timestamp < '2023-01-01'
GROUP BY
    app_id;
```

### 4.4. Step 4: Round the Result
The final requirement is to round the CTR to two decimal places using the `ROUND()` function.

```sql
SELECT
    app_id,
    ROUND(
        100.0 *
            SUM(CASE WHEN event_type = 'click' THEN 1 ELSE 0 END) /
            NULLIF(SUM(CASE WHEN event_type = 'impression' THEN 1 ELSE 0 END), 0),
        2
    ) AS ctr
FROM
    events
WHERE
    timestamp >= '2022-01-01' AND timestamp < '2023-01-01'
GROUP BY
    app_id;
```

## 5. Final Solution
The complete query combines all the steps into a single, efficient statement.

```sql
SELECT
    app_id,
    -- Round the final result to two decimal places
    ROUND(
        -- Multiply by 100.0 to get a percentage and avoid integer division
        100.0 *
        -- Numerator: Count of 'click' events
        SUM(CASE WHEN event_type = 'click' THEN 1 ELSE 0 END) /
        -- Denominator: Count of 'impression' events, protected against division by zero
        NULLIF(SUM(CASE WHEN event_type = 'impression' THEN 1 ELSE 0 END), 0),
        2
    ) AS ctr
FROM
    events
WHERE
    -- Filter for events that occurred within the year 2022
    timestamp >= '2022-01-01' AND timestamp < '2023-01-01'
-- Aggregate the counts for each unique app
GROUP BY
    app_id;
```

## 6. Result Verification

### 6.1. Example Output:
| app_id | ctr    |
|:-------|:-------|
| 123    | 50.00  |
| 234    | 100.00 |

### 6.2. Explanation:
*   **App 123**: Had 1 click and 2 impressions. CTR = `100.0 * (1 / 2)` = `50.00`.
*   **App 234**: Had 1 click and 1 impression. CTR = `100.0 * (1 / 1)` = `100.00`.
