# SQL Query: Median from a Frequency Table

## 1. Objective
> [!NOTE]
> This document explains a concise and powerful SQL query to calculate the median from a frequency table. This approach is highly efficient as it avoids the need to generate the full, expanded list of numbers.

## 2. Data Model

### 2.1. `Numbers` Table
Contains numbers and their corresponding frequencies.
| Number | Frequency |
|:-------|:----------|
| 0      | 7         |
| 1      | 1         |
| 2      | 3         |
| 3      | 1         |

**Conceptual Expanded Data**: The table above is a compact representation of the full dataset `[0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 3]`. Our goal is to find the median of this conceptual list.

## 3. Core Concept: Using Cumulative Frequency
To find the median from a frequency table, we must identify which number falls at the "middle" position of the conceptual expanded list. The key to this is calculating the **cumulative frequency** (a running total).

1.  **Total Count (N)**: First, find the total number of items by summing all frequencies.
2.  **Middle Position(s)**: The median is located at position(s) around `N / 2`.
3.  **Cumulative Sum (`cum_sum`)**: A running total of frequencies tells us the end position of each number's "block" in the conceptual list.
4.  **Identifying the Median's Block**: The number containing the median is the one whose block of positions includes the middle position. The range of positions for a given number is from `(previous cumulative sum)` to `(current cumulative sum)`.

> [!IMPORTANT]
> The query uses a clever `WHERE` clause: `WHERE middle BETWEEN (cum_sum - frequency) AND cum_sum`. This condition efficiently identifies the row(s) whose block of conceptual positions contains the middle position of the entire dataset.

## 4. Incremental Query Construction
We will use a Common Table Expression (CTE) to prepare the data before filtering for the median.

### 4.1. Step 1: Calculate Cumulative Sum and Middle Position
We use window functions to calculate a running total of the frequency (`cum_sum`) and find the middle position (`middle`) of the entire dataset.

```sql
-- This query will become our CTE
SELECT
    Number,
    Frequency,
    -- Calculate the running total of frequencies, ordered by Number.
    SUM(Frequency) OVER(ORDER BY Number) AS cum_sum,
    -- Calculate the middle position(s) of the entire dataset.
    (SUM(Frequency) OVER()) / 2.0 AS middle
FROM
    Numbers;
```
**Intermediate Result (`t1`):**
| Number | Frequency | cum_sum | middle |
|:-------|:----------|:--------|:-------|
| 0      | 7         | 7       | 6.0    |
| 1      | 1         | 8       | 6.0    |
| 2      | 3         | 11      | 6.0    |
| 3      | 1         | 12      | 6.0    |

### 4.2. Step 2: Filter for the Number(s) at the Median Position
With the `cum_sum` and `middle` values, we can now filter for the row that contains the median.

The `WHERE` clause `middle BETWEEN (cum_sum - frequency) AND cum_sum` checks if the middle position falls within the conceptual block of positions for the current number.
*   The block for `Number = 0` covers positions 1 through 7 (`cum_sum = 7`). The condition checks if `6.0` is between `7-7=0` and `7`. It is, so this row is kept.
*   The block for `Number = 1` covers position 8 (`cum_sum = 8`). The condition checks if `6.0` is between `8-1=7` and `8`. It is not, so this row is discarded.

### 4.3. Step 3: Calculate the Final Median with `AVG()`
We apply `AVG(Number)` to the filtered result.
> [!TIP]
> The `AVG()` function cleverly handles both odd and even total frequencies.
> - If the total frequency is odd, only one row will match the `WHERE` clause, and `AVG()` of a single number is just that number.
> - If the total frequency is even, it's possible for two rows to match (if the median falls exactly between two different numbers), and `AVG()` will correctly compute their average.

## 5. Final Solution
The complete query combines these steps into a concise and efficient solution.
```sql
-- CTE to calculate cumulative sum and the middle position
WITH t1 AS (
    SELECT
        Number,
        Frequency,
        SUM(Frequency) OVER(ORDER BY Number) AS cum_sum,
        (SUM(Frequency) OVER()) / 2.0 AS middle
    FROM Numbers
)
-- Select the number(s) where the middle position falls within its frequency block
SELECT
    AVG(CAST(Number AS DECIMAL)) AS median
FROM t1
WHERE
    middle BETWEEN (cum_sum - Frequency) AND cum_sum;
```

## 6. Result Analysis

### 6.1. Final Output
| median |
|:-------|
| 0.0000 |

### 6.2. Explanation
*   **Total Frequency**: `7 + 1 + 3 + 1 = 12`.
*   **Middle Position**: `12 / 2.0 = 6.0`.
*   **For `Number = 0`**: The cumulative sum is `7`. The frequency is `7`. The condition checks if `6.0` is `BETWEEN (7 - 7)` and `7`, which is `BETWEEN 0 AND 7`. This is true.
*   No other numbers satisfy the condition.
*   The query filters to the single row where `Number = 0`.
*   **Final Calculation**: `AVG(0)` is `0.0000`, which is the correct median.
