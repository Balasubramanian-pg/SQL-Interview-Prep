# Top 2 Highest-Grossing Products by Category

## 1. Objective
> [!NOTE]
> This document explains how to write a SQL query to identify the top two highest-grossing products within each category for the year 2022. The final output will include the category, product name, and the total spend for that product.

## 2. Data Model

### 2.1. `product_spend` Table
Contains transaction-level data for customer spending on various products.
| Column Name      | Type      |
|:-----------------|:----------|
| category         | string    |
| product          | string    |
| user_id          | integer   |
| spend            | decimal   |
| transaction_date | timestamp |

### 2.2. Example Data
| category    | product           | user_id | spend  | transaction_date      |
|:------------|:------------------|:--------|:-------|:----------------------|
| appliance   | refrigerator      | 165     | 246.00 | 12/26/2021 12:00:00   |
| appliance   | refrigerator      | 123     | 299.99 | 03/02/2022 12:00:00   |
| appliance   | washing machine   | 123     | 219.80 | 03/02/2022 12:00:00   |
| electronics | vacuum            | 178     | 152.00 | 04/05/2022 12:00:00   |
| electronics | wireless headset  | 156     | 249.90 | 07/08/2022 12:00:00   |
| electronics | vacuum            | 145     | 189.00 | 07/15/2022 12:00:00   |

## 3. Incremental Query Construction
The problem requires aggregating data, ranking it within groups, and then filtering based on that rank. A multi-CTE approach is well-suited for this logical flow.

### 3.1. Step 1: Calculate Total Spend per Product for 2022
First, we need to filter the data to include only transactions from 2022. Then, we aggregate the spend for each product within each category.

```sql
-- This will form our first CTE
SELECT
    category,
    product,
    SUM(spend) AS total_spend
FROM
    product_spend
WHERE
    EXTRACT(YEAR FROM transaction_date) = 2022
GROUP BY
    category, product;
```
**Intermediate Result (`product_totals`):**
| category    | product           | total_spend |
|:------------|:------------------|:------------|
| appliance   | refrigerator      | 299.99      |
| appliance   | washing machine   | 219.80      |
| electronics | vacuum            | 341.00      |
| electronics | wireless headset  | 249.90      |

### 3.2. Step 2: Rank Products Within Each Category by Spend
Now that we have the total spend for each product, we need to rank them within their respective categories. We will use a window function for this.

> [!TIP]
> `ROW_NUMBER()` is a good choice here. It assigns a unique rank to each product within a category based on its spend. If two products had the exact same spend, `ROW_NUMBER()` would arbitrarily assign them ranks (e.g., 2 and 3). If the business requirement was to include all products tied for second place, `RANK()` or `DENSE_RANK()` would be more appropriate.

```sql
-- This will form our second CTE, building on the first
SELECT
    category,
    product,
    total_spend,
    ROW_NUMBER() OVER (PARTITION BY category ORDER BY total_spend DESC) AS rnk
FROM
    product_totals; -- Assumes the previous query is in a CTE named product_totals
```
**Intermediate Result (`ranked_products`):**
| category    | product           | total_spend | rnk |
|:------------|:------------------|:------------|:----|
| appliance   | refrigerator      | 299.99      | 1   |
| appliance   | washing machine   | 219.80      | 2   |
| electronics | vacuum            | 341.00      | 1   |
| electronics | wireless headset  | 249.90      | 2   |

### 3.3. Step 3: Filter for the Top 2 Ranked Products
With the ranks assigned, the final step is to select only the rows where the rank is 1 or 2.

```sql
SELECT
    category,
    product,
    total_spend
FROM
    ranked_products -- Assumes the previous query is in a CTE named ranked_products
WHERE
    rnk <= 2;
```

## 4. Final Solution
The complete query combines these steps using Common Table Expressions (CTEs) for clarity and readability.

```sql
WITH product_totals AS (
  -- Step 1: Filter for 2022 and calculate total spend per product.
  SELECT
    category,
    product,
    SUM(spend) AS total_spend
  FROM product_spend
  WHERE EXTRACT(YEAR FROM transaction_date) = 2022
  GROUP BY category, product
),
ranked_products AS (
  -- Step 2: Rank products within each category based on total spend.
  SELECT
    category,
    product,
    total_spend,
    ROW_NUMBER() OVER (
      PARTITION BY category
      ORDER BY total_spend DESC
    ) AS rnk
  FROM product_totals
)
-- Step 3: Select only the top 2 ranked products from each category.
SELECT
  category,
  product,
  total_spend
FROM ranked_products
WHERE rnk <= 2
ORDER BY category, total_spend DESC;
```

## 5. Result Analysis

### 5.1. Final Output
| category    | product           | total_spend |
|:------------|:------------------|:------------|
| appliance   | refrigerator      | 299.99      |
| appliance   | washing machine   | 219.80      |
| electronics | vacuum            | 341.00      |
| electronics | wireless headset  | 249.90      |

### 5.2. Explanation
*   **Appliance Category**: The query correctly identifies "refrigerator" (`$299.99`) as rank 1 and "washing machine" (`$219.80`) as rank 2.
*   **Electronics Category**: The query correctly sums the spend for "vacuum" (`$152.00 + $189.00 = $341.00`) to rank it as #1, and identifies "wireless headset" (`$249.90`) as #2.
