# 35.Three-Month Rolling Salary Sum (Excluding Latest Month)

## 1. Objective
> [!NOTE]
> This document details how to write a SQL query to calculate a 3-month rolling sum of salaries for each employee. The query specifically excludes each employee's most recent month of data from the calculation.

## 2. Data Model

### 2.1. `employee` Table
Contains monthly salary records for employees.
| Id | Month | Salary |
|:---|:------|:-------|
| 1  | 1     | 20     |
| 1  | 2     | 30     |
| 1  | 3     | 40     |
| 1  | 4     | 60     |
| 2  | 1     | 20     |
| 2  | 2     | 30     |
| 3  | 2     | 40     |
| 3  | 3     | 60     |
| 3  | 4     | 70     |

## 3. Incremental Query Construction
The problem has two distinct parts: first, identifying and filtering out the most recent month for each employee, and second, calculating the 3-month rolling sum on the remaining data. We'll use a Common Table Expression (CTE) to handle this multi-step logic cleanly.

### 3.1. Step 1: Identify the Most Recent Month for Each Employee
To filter out the latest month, we first need to know what that month is for each employee. A window function is perfect for this.

> [!TIP]
> The window function `MAX(Month) OVER (PARTITION BY Id)` calculates the maximum month for each employee (`Id`) and attaches that value to every row belonging to that employee. This avoids a separate `GROUP BY` query and a join.

```sql
SELECT
    Id,
    Month,
    Salary,
    MAX(Month) OVER (PARTITION BY Id) AS recent_month
FROM
    employee;
```
**Intermediate Result:**
| Id | Month | Salary | recent_month |
|:---|:------|:-------|:-------------|
| 1  | 1     | 20     | 4            |
| 1  | 2     | 30     | 4            |
| 1  | 3     | 40     | 4            |
| 1  | 4     | 60     | 4            |
| 2  | 1     | 20     | 2            |
| 2  | 2     | 30     | 2            |
| 3  | 2     | 40     | 4            |
| 3  | 3     | 60     | 4            |
| 3  | 4     | 70     | 4            |

### 3.2. Step 2: Filter the Data
Now, we place the query from Step 1 into a CTE and filter it to exclude the most recent month's record for each employee.

```sql
WITH EmployeeWithRecentMonth AS (
    SELECT
        Id,
        Month,
        Salary,
        MAX(Month) OVER (PARTITION BY Id) AS recent_month
    FROM
        employee
)
SELECT
    Id,
    Month,
    Salary
FROM
    EmployeeWithRecentMonth
WHERE
    Month < recent_month;
```
**Intermediate Result (Filtered Data):**
| Id | Month | Salary |
|:---|:------|:-------|
| 1  | 1     | 20     |
| 1  | 2     | 30     |
| 1  | 3     | 40     |
| 2  | 1     | 20     |
| 3  | 2     | 40     |
| 3  | 3     | 60     |

### 3.3. Step 3: Calculate the 3-Month Rolling Sum
On this filtered data, we can now apply another window function to calculate the rolling sum.

> [!IMPORTANT]
> The window frame clause `ROWS BETWEEN 2 PRECEDING AND CURRENT ROW` defines the window for the `SUM()` function. For each row, it sums the `Salary` of the current row and the two rows that come before it, based on the `ORDER BY Month` clause.

The window function looks like this:
```sql
SUM(Salary) OVER (
    PARTITION BY Id
    ORDER BY Month
    ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
)
```

## 4. Final Solution
We combine these steps into a single query using a CTE. The rolling sum is calculated on the filtered data.

```sql
-- Step 1: Use a CTE to identify the most recent month for each employee.
WITH EmployeeWithRecentMonth AS (
    SELECT
        *,
        MAX(Month) OVER (PARTITION BY Id) AS recent_month
    FROM
        employee
)
-- Step 2: Calculate the 3-month rolling sum on the filtered data.
SELECT
    Id,
    Month,
    SUM(Salary) OVER (
        PARTITION BY Id -- Restart the sum for each employee.
        ORDER BY Month   -- Order the data by month to define the window.
        -- Define the window: current month + two previous months.
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ) AS Salary
FROM
    EmployeeWithRecentMonth
WHERE
    Month < recent_month -- Exclude the most recent month for each employee.
ORDER BY
    Id ASC, Month DESC; -- Order the final output as required.
```

## 5. Result Analysis

### 5.1. Final Output
| Id | Month | Salary |
|:---|:------|:-------|
| 1  | 3     | 90     |
| 1  | 2     | 50     |
| 1  | 1     | 20     |
| 2  | 1     | 20     |
| 3  | 3     | 100    |
| 3  | 2     | 40     |

### 5.2. Explanation
*   **For Id = 1**:
    *   The most recent month is 4, which is excluded.
    *   **Month 3**: Sum = `Salary(M3) + Salary(M2) + Salary(M1)` = `40 + 30 + 20` = `90`.
    *   **Month 2**: Sum = `Salary(M2) + Salary(M1)` = `30 + 20` = `50`. (Only one preceding row exists).
    *   **Month 1**: Sum = `Salary(M1)` = `20`. (No preceding rows exist).
*   **For Id = 2**:
    *   The most recent month is 2, which is excluded.
    *   **Month 1**: Sum = `Salary(M1)` = `20`.
*   **For Id = 3**:
    *   The most recent month is 4, which is excluded.
    *   **Month 3**: Sum = `Salary(M3) + Salary(M2)` = `60 + 40` = `100`. (Only one preceding row exists in the filtered set).
    *   **Month 2**: Sum = `Salary(M2)` = `40`.

