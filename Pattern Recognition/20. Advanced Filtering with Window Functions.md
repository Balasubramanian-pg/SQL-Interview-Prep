**Pattern**: Filtering based on aggregates within groups.

**Decomposition Strategy**:

1. Calculate window aggregates
2. Apply filters using the calculated values
3. Use CTEs to separate calculation from filtering

**Example**: "Find products that have above-average sales within their category."

```SQL
WITH category_stats AS (
    SELECT
        product_id,
        category_id,
        sales_amount,
        AVG(sales_amount) OVER (PARTITION BY category_id) AS category_avg
    FROM product_sales
)
SELECT
    product_id,
    category_id,
    sales_amount
FROM category_stats
WHERE sales_amount > category_avg;
```