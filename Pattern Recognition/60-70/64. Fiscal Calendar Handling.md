# Pattern: Working with non-standard calendar periods.

**The Gist**: Your company's year-end isn't December 31st. So, regular date functions don't work for quarterly reports or yearly comparisons. You gotta translate real dates into "company dates."

> [!NOTE]
> This pattern is essential when a business operates on a **fiscal calendar** that doesn't align with the standard Gregorian calendar (Jan 1 - Dec 31). This affects how you define years, quarters, and even months for reporting.

### Decomposition Strategy: (Making sense of the "other" calendar)

#### 1. Define fiscal period boundaries.

*   This is step one. What's the start date of their fiscal year? February 1st, July 1st? This single piece of info changes *everything*. Without it, you're dead in the water.

#### 2. Create mapping between standard and fiscal dates.

*   This is the core translation. For every standard date, you need to figure out:
    *   What `fiscal_year` does it belong to?
    *   What `fiscal_quarter` does it belong to?
    *   What `fiscal_month` does it belong to?
*   This usually involves a lot of `CASE` statements or clever date arithmetic, shifting the month numbers.

#### 3. Implement fiscal date arithmetic.

*   Once you've mapped, you can then start doing actual calculations, like "sales for Q1 FY2023."
*   This is also where you'd handle things like comparing "this fiscal quarter" to "last fiscal quarter" or "this fiscal quarter last year."

#### 4. Calculate aggregates by fiscal periods.

*   Finally, with your dates properly categorized, you can `GROUP BY` your `fiscal_year`, `fiscal_quarter`, etc., and do your `SUM()`, `AVG()`, `COUNT()` as needed.

> [!IMPORTANT]
> The exact `CASE` logic for calculating `fiscal_year`, `fiscal_quarter`, and `fiscal_month` depends *entirely* on the fiscal year start date. A Feb 1st start will have different logic than a July 1st start. Don't just copy-paste; understand the shift.

---

### Example: "Calculate sales by fiscal quarter where fiscal year starts February 1."

**What we've got**: A `sales` table with `sale_date` and `amount`.

**Sample Data (Imagine a mix of dates and sales):**

| sale_date  | amount |
| :--------- | :----- |
| 2023-01-15 | 100    |
| 2023-02-10 | 150    |
| 2023-03-05 | 200    |
| 2023-04-20 | 120    |
| 2023-05-18 | 300    |
| 2024-01-25 | 180    |
| 2024-02-14 | 250    |

**The SQL (The translation engine):**

```sql
-- Step 1 & 2: Define fiscal period boundaries and create mapping
-- This CTE is doing the heavy lifting of translating standard dates to fiscal dates.
WITH fiscal_periods AS (
    SELECT
        sale_date,
        amount,
        -- Calculate fiscal year: If sale_month is >= Feb (2), it's the current calendar year.
        -- Otherwise (Jan), it's part of the *previous* calendar year's fiscal year.
        CASE
            WHEN EXTRACT(MONTH FROM sale_date) >= 2 THEN EXTRACT(YEAR FROM sale_date)
            ELSE EXTRACT(YEAR FROM sale_date) - 1
        END AS fiscal_year,
        -- Calculate fiscal quarter:
        -- Feb-Apr is Q1, May-Jul is Q2, Aug-Oct is Q3, Nov-Jan is Q4.
        CASE
            WHEN EXTRACT(MONTH FROM sale_date) BETWEEN 2 AND 4 THEN 1 -- Feb, Mar, Apr
            WHEN EXTRACT(MONTH FROM sale_date) BETWEEN 5 AND 7 THEN 2 -- May, Jun, Jul
            WHEN EXTRACT(MONTH FROM sale_date) BETWEEN 8 AND 10 THEN 3 -- Aug, Sep, Oct
            ELSE 4 -- Nov, Dec, Jan
        END AS fiscal_quarter,
        -- Calculate fiscal month (1-12, where Feb is 1, Mar is 2, ..., Jan is 12)
        -- EXTRACT(MONTH FROM sale_date) - 2: shifts Feb (2) to 0, Mar (3) to 1, ..., Jan (1) to -1.
        -- + 12: handles negative results (Jan becomes 11).
        -- % 12: wraps around.
        -- + 1: shifts 0-11 range to 1-12.
        (EXTRACT(MONTH FROM sale_date) - 2 + 12) % 12 + 1 AS fiscal_month
    FROM sales
)

-- Step 4: Calculate aggregates by fiscal periods (Basic total sales per fiscal quarter)
SELECT
    fiscal_year,
    fiscal_quarter,
    'Q' || fiscal_quarter || ' FY' || fiscal_year AS fiscal_period_label, -- Nicer label for reporting
    SUM(amount) AS total_sales
FROM fiscal_periods
GROUP BY fiscal_year, fiscal_quarter
ORDER BY fiscal_year, fiscal_quarter;
```

**Execution Trace for the first part (Example for `2023-01-15` and `2023-02-10`):**

*   **`2023-01-15` (Jan)**:
    *   `EXTRACT(MONTH)` is 1.
    *   `fiscal_year`: `WHEN 1 >= 2` is false, so `EXTRACT(YEAR) - 1` -> `2023 - 1 = 2022`. (Jan 2023 is in FY2022).
    *   `fiscal_quarter`: `WHEN 1 BETWEEN 2 AND 4` is false, etc. -> `ELSE 4`. (Jan is Q4).
    *   `fiscal_month`: `(1 - 2 + 12) % 12 + 1` -> `(-1 + 12) % 12 + 1` -> `11 % 12 + 1` -> `11 + 1 = 12`. (Jan is FM12).
    *   Result: `fiscal_year=2022, fiscal_quarter=4, fiscal_month=12`
*   **`2023-02-10` (Feb)**:
    *   `EXTRACT(MONTH)` is 2.
    *   `fiscal_year`: `WHEN 2 >= 2` is true, so `EXTRACT(YEAR)` -> `2023`. (Feb 2023 is in FY2023).
    *   `fiscal_quarter`: `WHEN 2 BETWEEN 2 AND 4` is true -> `1`. (Feb is Q1).
    *   `fiscal_month`: `(2 - 2 + 12) % 12 + 1` -> `(0 + 12) % 12 + 1` -> `0 % 12 + 1` -> `0 + 1 = 1`. (Feb is FM1).
    *   Result: `fiscal_year=2023, fiscal_quarter=1, fiscal_month=1`

---

### Part 2: Compare to previous fiscal year

This demonstrates how you build on the fiscal period mapping for more advanced analysis.

```sql
-- First CTE is the same as before, mapping standard dates to fiscal periods.
-- (Omitted here for brevity, assume 'fiscal_periods' CTE is defined)

-- Step 3 & 4: Calculate current and previous year's sales, then compare.
WITH fiscal_sales AS (
    -- Aggregate the sales by fiscal year and quarter from our mapped periods.
    SELECT
        fiscal_year,
        fiscal_quarter,
        SUM(amount) AS quarterly_sales
    FROM fiscal_periods -- Use the CTE from the first part.
    GROUP BY fiscal_year, fiscal_quarter
)

SELECT
    current.fiscal_year,
    current.fiscal_quarter,
    current.quarterly_sales AS current_sales,
    prev.quarterly_sales AS previous_year_sales,
    -- Calculate growth percentage, handling potential division by zero if prev.quarterly_sales is NULL or 0.
    CASE
        WHEN prev.quarterly_sales IS NULL OR prev.quarterly_sales = 0 THEN NULL -- Or 0, depending on business rule.
        ELSE (current.quarterly_sales - prev.quarterly_sales) / prev.quarterly_sales * 100
    END AS growth_percentage
FROM fiscal_sales current
LEFT JOIN fiscal_sales prev
    -- Join current quarter to the *same* quarter in the *previous* fiscal year.
    ON current.fiscal_quarter = prev.fiscal_quarter
    AND current.fiscal_year = prev.fiscal_year + 1 -- This is the key for year-over-year comparison.
ORDER BY current.fiscal_year, current.fiscal_quarter;
```

> [!CAUTION]
> When doing year-over-year comparisons with `LEFT JOIN`, make sure to handle cases where there might not be data for the `prev.fiscal_year`. If `prev.quarterly_sales` is `NULL`, any arithmetic will result in `NULL`. The `CASE` statement added for `growth_percentage` is a practical way to manage this, preventing errors or unexpected `NULL` results.

> [!IMPORTANT]
> The `LEFT JOIN` condition `current.fiscal_year = prev.fiscal_year + 1` is critical for correctly aligning current year data with the previous year's data for comparison. This is a standard pattern for YOY (Year-over-Year) analysis.
