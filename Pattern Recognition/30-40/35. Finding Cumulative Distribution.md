# **Pattern**: Calculating cumulative percentages of a distribution.

**Decomposition Strategy**:

1. Order values by the metric of interest
2. Calculate running count/sum
3. Divide by total count/sum to get percentages

**Example**: "Calculate what percentage of total revenue comes from the top X% of customers."

```SQL
WITH customer_revenue AS (
    SELECT
        customer_id,
        SUM(amount) AS total_spent,
        PERCENT_RANK() OVER (ORDER BY SUM(amount) DESC) AS percentile
    FROM orders
    GROUP BY customer_id
),

revenue_distribution AS (
    SELECT
        FLOOR(percentile * 10) * 10 AS percentile_bucket,
        SUM(total_spent) AS revenue
    FROM customer_revenue
    GROUP BY FLOOR(percentile * 10) * 10
),

running_totals AS (
    SELECT
        percentile_bucket,
        revenue,
        SUM(revenue) OVER (ORDER BY percentile_bucket) AS cumulative_revenue,
        SUM(revenue) OVER () AS total_revenue
    FROM revenue_distribution
)

SELECT
    percentile_bucket AS customer_percentile,
    revenue,
    cumulative_revenue,
    cumulative_revenue / total_revenue * 100 AS cumulative_percentage
FROM running_totals
ORDER BY customer_percentile;
```

I'll decompose this SQL query step by step, explaining each component and its purpose:

## 1. **customer_revenue CTE** - Individual Customer Analysis
```sql
WITH customer_revenue AS (
    SELECT
        customer_id,
        SUM(amount) AS total_spent,
        PERCENT_RANK() OVER (ORDER BY SUM(amount) DESC) AS percentile
    FROM orders
    GROUP BY customer_id
)
```
**Purpose**: Calculate each customer's total spending and their percentile rank
- `SUM(amount)`: Total amount spent by each customer
- `PERCENT_RANK() OVER (ORDER BY SUM(amount) DESC)`: Assigns percentile rank (0-1) where highest spenders get lower percentiles
- **Output**: Customer ID, their total spending, and percentile position

## 2. **revenue_distribution CTE** - Group into Percentile Buckets
```sql
revenue_distribution AS (
    SELECT
        FLOOR(percentile * 10) * 10 AS percentile_bucket,
        SUM(total_spent) AS revenue
    FROM customer_revenue
    GROUP BY FLOOR(percentile * 10) * 10
)
```
**Purpose**: Group customers into 10% buckets and sum their revenue
- `FLOOR(percentile * 10) * 10`: Creates buckets (0, 10, 20, ..., 90)
- **Output**: Each 10% bucket with total revenue from customers in that bucket

## 3. **running_totals CTE** - Calculate Cumulative Values
```sql
running_totals AS (
    SELECT
        percentile_bucket,
        revenue,
        SUM(revenue) OVER (ORDER BY percentile_bucket) AS cumulative_revenue,
        SUM(revenue) OVER () AS total_revenue
    FROM revenue_distribution
)
```
**Purpose**: Calculate running totals and overall total
- `SUM(revenue) OVER (ORDER BY percentile_bucket)`: Cumulative revenue from lowest to highest percentiles
- `SUM(revenue) OVER ()`: Total revenue across all buckets
- **Output**: Buckets with their revenue, cumulative revenue, and total revenue

## 4. **Final SELECT** - Calculate Percentages
```sql
SELECT
    percentile_bucket AS customer_percentile,
    revenue,
    cumulative_revenue,
    cumulative_revenue / total_revenue * 100 AS cumulative_percentage
FROM running_totals
ORDER BY customer_percentile;
```
**Purpose**: Convert to readable percentages and present results
- `cumulative_revenue / total_revenue * 100`: Percentage of total revenue from each cumulative point
- **Final Output**: Shows what % of total revenue comes from bottom X% of customers

## **Overall Pattern Flow**:
1. **Individual Analysis** → 2. **Bucket Grouping** → 3. **Cumulative Calculation** → 4. **Percentage Conversion**

## **Key Insights This Query Provides**:
- Revenue concentration analysis (Pareto principle)
- How much revenue comes from top/bottom customer segments
- Customer value distribution across percentiles

The query effectively demonstrates the cumulative percentage pattern by progressively building from individual data points to aggregated insights about revenue distribution.
