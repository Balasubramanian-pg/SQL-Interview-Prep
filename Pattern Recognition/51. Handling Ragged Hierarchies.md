**Pattern**: Managing hierarchical data with inconsistent depths.

**Decomposition Strategy**:

1. Use recursive CTEs with path tracking
2. Implement materialized path pattern
3. Handle special cases for leaf nodes
4. Include level information

**Example**: "Query product categories in a multi-level hierarchy."

```SQL
WITH RECURSIVE category_tree AS (
    -- Base case: top-level categories
    SELECT
        category_id,
        category_name,
        parent_id,
        1 AS level,
        CAST(category_id AS VARCHAR(255)) AS path,
        category_name AS path_name
    FROM categories
    WHERE parent_id IS NULL

    UNION ALL

    -- Recursive case: child categories
    SELECT
        c.category_id,
        c.category_name,
        c.parent_id,
        ct.level + 1,
        ct.path || ',' || c.category_id,
        ct.path_name || ' > ' || c.category_name
    FROM categories c
    JOIN category_tree ct ON c.parent_id = ct.category_id
)

SELECT
    category_id,
    category_name,
    level,
    path,
    path_name
FROM category_tree
ORDER BY path;

-- Query only items in leaf categories
SELECT
    p.product_id,
    p.product_name,
    c.path_name AS category_path
FROM products p
JOIN category_tree c ON p.category_id = c.category_id
WHERE NOT EXISTS (
    SELECT 1 FROM categories
    WHERE parent_id = c.category_id
);
```