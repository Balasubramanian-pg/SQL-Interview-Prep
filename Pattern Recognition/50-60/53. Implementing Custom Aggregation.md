**Pattern**: Creating specialized aggregation functions.

**Decomposition Strategy**:

1. Define the aggregation logic
2. Use window functions or GROUP BY
3. Handle edge cases and null values
4. Optimize for performance

**Example**: "Calculate weighted average price by sales volume."

```SQL
-- Simple weighted average
SELECT
    category_id,
    SUM(price * sales_quantity) / SUM(sales_quantity) AS weighted_avg_price
FROM product_sales
GROUP BY category_id;

-- More complex custom aggregation (median)
WITH ordered_values AS (
    SELECT
        category_id,
        price,
        ROW_NUMBER() OVER (PARTITION BY category_id ORDER BY price) AS row_num,
        COUNT(*) OVER (PARTITION BY category_id) AS total_count
    FROM product_sales
),

median_positions AS (
    SELECT
        category_id,
        total_count,
        CEILING(total_count / 2.0) AS median_pos_1,
        CEILING(total_count / 2.0) + (1 - total_count % 2) AS median_pos_2
    FROM ordered_values
    GROUP BY category_id, total_count
)

SELECT
    m.category_id,
    (o1.price + o2.price) / 2.0 AS median_price
FROM median_positions m
JOIN ordered_values o1
    ON m.category_id = o1.category_id AND o1.row_num = m.median_pos_1
JOIN ordered_values o2
    ON m.category_id = o2.category_id AND o2.row_num = m.median_pos_2;
```
