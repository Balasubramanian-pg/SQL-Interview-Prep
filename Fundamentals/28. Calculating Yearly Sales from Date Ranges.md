This query solves the problem of calculating total sales by year for products with varying sales periods, using a recursive CTE to generate all dates in the range and then joining with the sales data.

## Complete Solution

```SQL
WITH date_range AS (
    -- Anchor: Get the earliest start date and latest end date
    SELECT
        MIN(period_start) AS start_date,
        MAX(period_end) AS end_date
    FROM sales

    UNION ALL

    -- Recursive part: Generate each subsequent day
    SELECT
        DATEADD(day, 1, start_date),
        end_date
    FROM date_range
    WHERE start_date < end_date
),
-- Calculate sales by product and year
yearly_sales AS (
    SELECT
        s.product_id,
        YEAR(d.start_date) AS report_year,
        SUM(s.average_daily_sales) AS total_amount
    FROM date_range d
    INNER JOIN sales s ON d.start_date BETWEEN s.period_start AND s.period_end
    GROUP BY s.product_id, YEAR(d.start_date)
)
SELECT
    product_id,
    report_year,
    total_amount
FROM yearly_sales
ORDER BY product_id, report_year
OPTION (MAXRECURSION 10000);  -- Increase recursion limit if needed
```

## Explanation:

1. **Recursive CTE (**`**date_range**`**)**:
    - Anchor member gets the overall date range (min start to max end)
    - Recursive member generates each consecutive day until reaching end_date
    - Creates a row for every day in the entire sales period range
2. **Sales Calculation**:
    - Joins the generated dates with sales data
    - Filters to only include dates within each product's sales period
    - Groups by product_id and year to calculate yearly totals
3. **Final Output**:
    - Returns product_id, year, and total sales amount
    - Ordered by product and year for clear presentation

## Example Output:

For the sample data, the query would return:

|   |   |   |
|---|---|---|
|product_id|report_year|total_amount|
|1|2019|3500|
|2|2018|310|
|2|2019|3650|
|2|2020|10|
|3|2019|31|
|3|2020|31|

## Key Features:

1. **Handles multi-year periods** by properly allocating sales to each year
2. **Accurate daily calculation** for partial months/years
3. **Flexible** for any date ranges in the input data
4. **OPTION (MAXRECURSION)** ensures it works for large date ranges

This approach is particularly useful for financial reporting where sales need to be accurately allocated to specific fiscal years, even when sales periods cross year boundaries.