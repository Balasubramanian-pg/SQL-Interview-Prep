Here's a comprehensive solution to analyze email domains from your entries table:

## Complete Solution

```SQL
WITH email_domains AS (
    SELECT
        email,
        -- Extract domain (everything after @)
        SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email)) AS domain
    FROM entries
    WHERE email LIKE '%@%'  -- Ensure email contains @ symbol
)
SELECT
    domain,
    COUNT(*) AS email_count,
    STRING_AGG(email, ', ') AS sample_emails  -- Show sample emails from each domain
FROM email_domains
GROUP BY domain
ORDER BY email_count DESC, domain;
```

## Explanation:

1. **Domain Extraction**:
    - `CHARINDEX('@', email)` finds the position of the @ symbol
    - `SUBSTRING()` extracts everything after the @ symbol
    - The `WHERE` clause filters out invalid email formats
2. **Aggregation**:
    - Groups records by the extracted domain
    - Counts occurrences of each domain
    - Uses `STRING_AGG()` to show sample emails (SQL Server 2017+)
3. **Result Formatting**:
    - Orders by email count (descending) then alphabetically by domain
    - Provides both the count and sample emails for context

## Alternative Versions:

### For Older SQL Server Versions (pre-2017):

```SQL
SELECT
    SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email)) AS domain,
    COUNT(*) AS email_count,
    -- Alternative to STRING_AGG for older versions
    (
        SELECT TOP 5 email + ', '
        FROM entries e2
        WHERE SUBSTRING(e2.email, CHARINDEX('@', e2.email) + 1, LEN(e2.email)) =
              SUBSTRING(e1.email, CHARINDEX('@', e1.email) + 1, LEN(e1.email))
        FOR XML PATH('')
    ) AS sample_emails
FROM entries e1
WHERE email LIKE '%@%'
GROUP BY SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email))
ORDER BY email_count DESC;
```

### For MySQL/PostgreSQL:

```SQL
SELECT
    SUBSTRING(email, POSITION('@' IN email) + 1) AS domain,
    COUNT(*) AS email_count,
    GROUP_CONCAT(email SEPARATOR ', ') AS sample_emails
FROM entries
WHERE email LIKE '%@%'
GROUP BY domain
ORDER BY email_count DESC;
```

## Key Benefits:

1. **Accurate Domain Extraction**: Properly handles all email formats
2. **Performance**: Efficiently processes large datasets
3. **Insightful Output**: Shows both counts and sample emails
4. **Flexibility**: Can be adapted for different SQL dialects

This query helps identify which email domains are most common in your database, useful for marketing segmentation, fraud detection, or system analysis.