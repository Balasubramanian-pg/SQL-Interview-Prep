This solution finds people who have friends with a total combined score greater than 100, along with their personal details and friend count.

## Solution

```SQL
WITH score_details AS (
    SELECT
        f.personid,
        SUM(p.score) AS total_friend_score,
        COUNT(1) AS no_of_friends
    FROM friend f
    INNER JOIN person p ON f.friend_id = p.person_id  -- Corrected join condition
    GROUP BY f.personid
    HAVING SUM(p.score) > 100
)
SELECT
    s.*,
    p.name AS person_name,
    p.score AS person_score
FROM person p
INNER JOIN score_details s ON p.person_id = s.personid;
```

## Explanation

### 1. Corrected Join Condition

The key fix was changing the join from `f.personid=p.person_id` to `f.friend_id=p.person_id` to properly:

- Link each person to their friends' records
- Calculate the sum of friends' scores (not their own score)

### 2. CTE Breakdown (`score_details`)

- Groups data by `personid` (the person whose friends we're analyzing)
- For each person:
    - Calculates total score of all their friends (`SUM(p.score)`)
    - Counts how many friends they have (`COUNT(1)`)
    - Filters to only include people whose friends have combined score > 100 (`HAVING`)

### 3. Final Query

- Joins the CTE with the person table to:
    - Get the person's name
    - Include their personal score
    - Show the friend analysis from the CTE

## Expected Output

For the given data, the query would return:

|   |   |   |   |   |
|---|---|---|---|---|
|personid|total_friend_score|no_of_friends|person_name|person_score|
|1|38 (11+27)|2|Alice|88|
|2|115 (88+27)|2|bob|11|
|4|101 (11+27+63)|3|tara|45|

## Key Insights

1. Alice has 2 friends (bob and davis) with combined score 38 (but won't appear in results as 38 < 100)
2. bob has 2 friends (Alice and davis) with combined score 115
3. tara has 3 friends (bob, davis, john) with combined score 101

This query effectively identifies people whose social circle has high-achieving friends.