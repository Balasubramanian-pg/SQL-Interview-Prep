Here's a refined solution to find employees whose salary is:

1. Greater than their department's average salary
2. But less than the overall company average salary

## Optimized Solution

```SQL
WITH department_stats AS (
    SELECT
        department_id,
        AVG(salary) AS dept_avg_salary
    FROM emp
    GROUP BY department_id
),
company_stats AS (
    SELECT AVG(salary) AS company_avg_salary
    FROM emp
)
SELECT
    e.emp_id,
    e.emp_name,
    e.department_id,
    e.salary,
    ds.dept_avg_salary,
    cs.company_avg_salary
FROM emp e
JOIN department_stats ds ON e.department_id = ds.department_id
CROSS JOIN company_stats cs
WHERE e.salary > ds.dept_avg_salary
AND e.salary < cs.company_avg_salary
ORDER BY e.department_id, e.salary DESC;
```

## Key Improvements:

1. **Using CTEs**:
    - `department_stats` calculates department averages once
    - `company_stats` calculates the overall company average once
2. **Performance**:
    - Avoids recalculating averages for each row
    - Uses CROSS JOIN for the company average which is efficient
3. **Readability**:
    - Clear separation of calculation steps
    - Includes all relevant metrics in the output
4. **Additional Information**:
    - Shows both department and company averages for reference
    - Sorts results by department and salary (descending)

## Alternative Version (More Concise):

```SQL
SELECT
    e.emp_id,
    e.emp_name,
    e.department_id,
    e.salary
FROM emp e
WHERE e.salary > (SELECT AVG(salary) FROM emp e2 WHERE e2.department_id = e.department_id)
AND e.salary < (SELECT AVG(salary) FROM emp)
ORDER BY e.department_id, e.salary DESC;
```

## Business Use Case:

This query helps identify:

- High performers within their departments (above department average)
- Who are still earning less than the company-wide average
- Useful for compensation analysis and identifying potential retention risks

For very large tables, ensure you have proper indexes on:

- `department_id` (for the department average calculation)
- `salary` (for the company average calculation)