## Problem Statement

Analyze customer orders to distinguish between new customers (first-time purchasers) and repeat customers (returning purchasers) for each order date.

## Solution Approach

### Step 1: Identify First Visit Dates

```SQL
SELECT customer_id, MIN(order_date) AS first_visit_date
FROM customer_orders
GROUP BY customer_id;
```

This finds each customer's first purchase date.

### Step 2: Create Visit Flags (Detailed View)

```SQL
WITH first_date AS (
    SELECT customer_id, MIN(order_date) AS first_visit_date
    FROM customer_orders
    GROUP BY customer_id
)
SELECT
    co.*,
    fv.first_visit_date,
    CASE WHEN co.order_date = fv.first_visit_date THEN 1 ELSE 0 END AS first_visit_flag,
    CASE WHEN co.order_date != fv.first_visit_date THEN 1 ELSE 0 END AS repeat_visit_flag
FROM customer_orders co
INNER JOIN first_date fv ON co.customer_id = fv.customer_id
ORDER BY order_id;
```

This shows each order with flags indicating if it was a first or repeat purchase.

### Step 3: Aggregate by Date (Final Solution)

```SQL
WITH first_date AS (
    SELECT customer_id, MIN(order_date) AS first_visit_date
    FROM customer_orders
    GROUP BY customer_id
)
SELECT
    co.order_date,
    SUM(CASE WHEN co.order_date = fv.first_visit_date THEN 1 ELSE 0 END) AS no_of_new_customer,
    SUM(CASE WHEN co.order_date != fv.first_visit_date THEN 1 ELSE 0 END) AS no_of_repeat_customer
FROM customer_orders co
INNER JOIN first_date fv ON co.customer_id = fv.customer_id
GROUP BY co.order_date;
```

## Key Concepts

1. **First Visit Identification**:
    - Using `MIN(order_date)` with `GROUP BY customer_id` finds each customer's initial purchase date
2. **Flagging Logic**:
    - `CASE WHEN` statements create binary flags (1/0) for new vs repeat purchases
    - First visit: `order_date = first_visit_date`
    - Repeat visit: `order_date != first_visit_date`
3. **Aggregation**:
    - `SUM()` of the flags counts occurrences for each date
    - `GROUP BY order_date` provides daily metrics

## Optimized Query Notes

- The final query combines steps by calculating sums directly without an intermediate CTE
- This approach is more efficient as it:
    - Avoids creating a temporary result set with flags
    - Performs aggregation in a single pass
    - Still maintains clear logic through the CASE statements

## Expected Output

For the provided data, the query would return:

```Plain
order_date | no_of_new_customer | no_of_repeat_customer
-----------+--------------------+----------------------
2022-01-01 | 3                  | 0
2022-01-02 | 2                  | 1
2022-01-03 | 1                  | 2
```

## Business Applications

This analysis helps:

- Track customer acquisition vs retention
- Measure marketing campaign effectiveness
- Identify trends in customer purchasing behavior
- Calculate repeat purchase rates over time