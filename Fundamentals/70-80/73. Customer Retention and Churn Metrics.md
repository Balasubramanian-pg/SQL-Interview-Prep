## Understanding Customer Retention and Churn

**Customer Retention** measures how many customers continue doing business with you over time.

**Customer Churn** measures how many customers you're losing.

## Data Setup

```SQL
CREATE TABLE transactionss(
    order_id int,
    cust_id int,
    order_date date,
    amount int
);

INSERT INTO transactionss VALUES
(1,1,'2020-01-15',150),
(2,1,'2020-02-10',150),
(3,2,'2020-01-16',150),
(4,2,'2020-02-25',150),
(5,3,'2020-01-10',150),
(6,3,'2020-02-20',150),
(7,4,'2020-01-20',150),
(8,5,'2020-02-20',150);
```

## 1. Customer Retention Calculation

```SQL
SELECT
    MONTH(this_month.order_date) AS month_date,
    COUNT(DISTINCT last_month.cust_id) AS retained_customers
FROM transactionss this_month
LEFT JOIN transactionss last_month
    ON this_month.cust_id = last_month.cust_id
    AND DATEDIFF(MONTH, last_month.order_date, this_month.order_date) = 1
GROUP BY MONTH(this_month.order_date)
ORDER BY month_date;
```

**Results**:

- January: 0 (no previous month to compare)
- February: 3 (customers 1, 2, and 3 who also purchased in January)

## 2. Customer Churn Calculation

```SQL
SELECT
    MONTH(last_month.order_date) AS month_date,
    COUNT(DISTINCT last_month.cust_id) AS churned_customers
FROM transactionss last_month
LEFT JOIN transactionss this_month
    ON this_month.cust_id = last_month.cust_id
    AND DATEDIFF(MONTH, last_month.order_date, this_month.order_date) = 1
WHERE this_month.cust_id IS NULL
GROUP BY MONTH(last_month.order_date)
ORDER BY month_date;
```

**Results**:

- January: 1 (customer 4 who didn't purchase in February)
- February: 2 (customers 4 and 5 - we can't see March data to know if they returned)

## Key Insights

1. **Retention Analysis**:
    - 3 out of 4 January customers returned in February (75% retention rate)
    - Customer 4 was lost after January
2. **Churn Analysis**:
    - January had 1 churned customer (25% churn rate)
    - February had 2 customers whose future behavior is unknown
3. **Business Implications**:
    - Retention programs appear effective for 75% of customers
    - Need to investigate why customer 4 didn't return
    - Need more data to assess February customer behavior

## Alternative Approach Using Window Functions

```SQL
WITH monthly_customers AS (
    SELECT
        cust_id,
        MONTH(order_date) AS month_date,
        LEAD(MONTH(order_date)) OVER(PARTITION BY cust_id ORDER BY order_date) AS next_month
    FROM transactionss
)
SELECT
    month_date,
    COUNT(DISTINCT cust_id) AS retained_customers
FROM monthly_customers
WHERE next_month = month_date + 1 OR (month_date = 12 AND next_month = 1)
GROUP BY month_date;
```

This approach uses LEAD() to find consecutive months more efficiently.
