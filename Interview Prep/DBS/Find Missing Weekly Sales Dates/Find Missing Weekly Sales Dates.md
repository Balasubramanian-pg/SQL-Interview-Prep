# Find Missing Weekly Sales Dates

## 1. Overview
This document explains how to solve a common SQL interview question that involves identifying gaps in a time-series dataset. The specific task is to find all the missing weekly dates within a given range in a sales table. This problem tests your ability to dynamically generate a complete data series using a **recursive Common Table Expression (CTE)** and then use set operators like `EXCEPT` to find the difference between the complete series and the actual data.

> [!IMPORTANT]
> The core challenge in this problem is that you cannot find data that doesn't exist by querying the table alone. You must first generate a complete, unbroken sequence of all possible weekly dates within the range and then compare your actual data against this complete sequence to identify the gaps.

## 2. Problem Statement

### 2.1. The Scenario
You are given a `sales` table that logs sales on a weekly basis.

**sales:**
| product_id | sales_date | sales_amount |
|------------|------------|--------------|
| 101        | 2024-07-11 | 500          |
| 102        | 2024-07-18 | 600          |
| 103        | 2024-07-25 | 700          |
| 104        | 2024-08-01 | 800          |
| 105        | 2024-08-15 | 900          |
| 106        | 2024-08-29 | 1000         |

### 2.2. The Requirement
Write a SQL query to identify all the weekly sales dates that are missing from the continuous sequence defined by the minimum and maximum `sales_date` in the table.

-   The sequence starts on `2024-07-11`.
-   The week after `2024-08-01` should be `2024-08-08`, but it is missing.
-   The week after `2024-08-15` should be `2024-08-22`, but it is missing.

**Expected Output:**
| missing_week_date |
|-------------------|
| 2024-08-08        |
| 2024-08-22        |

## 3. Setup Script
You can use the following T-SQL script to create the table and populate it with the sample data.

```sql
-- Create the table
CREATE TABLE sales (
    product_id INT,
    sales_date DATE,
    sales_amount INT
);
GO

-- Insert sample data
INSERT INTO sales (product_id, sales_date, sales_amount) VALUES
(101, '2024-07-11', 500),
(102, '2024-07-18', 600),
(103, '2024-07-25', 700),
(104, '2024-08-01', 800),
(105, '2024-08-15', 900),
(106, '2024-08-29', 1000);
GO

-- Verify the initial data
SELECT * FROM sales;
```

## 4. Solution and Explanation
The solution involves three logical steps:
1.  Determine the start and end dates of the period.
2.  Generate a complete, unbroken series of weekly dates for that period.
3.  Compare the complete series with the actual dates in the table to find the missing ones.

### 4.1. Step 1: Determine the Date Range
We first find the minimum and maximum `sales_date` from our table. These will serve as the boundaries for our date generation.

### 4.2. Step 2: Generate All Possible Weeks with a Recursive CTE
A recursive CTE is the perfect tool for generating a sequence of dates.
-   **Anchor Member**: The recursion starts with the minimum date from the `sales` table.
-   **Recursive Member**: In each subsequent step, we use the `DATEADD` function to add one week to the date from the previous step.
-   **Termination Condition**: The recursion stops when the newly generated date exceeds the maximum date from the `sales` table.

### 4.3. Step 3: Find the Missing Dates using `EXCEPT`
The `EXCEPT` set operator returns all distinct rows from the first query that are not found in the second query.
-   We take the complete list of weekly dates generated by our CTE.
-   We subtract the list of weekly dates that actually exist in the `sales` table.
-   The result is the set of missing dates.

## 5. The Complete SQL Query (Using a Recursive CTE)
This query implements the three-step logic in a single, readable block.

```sql
-- Step 1: Declare variables to hold the min and max dates from the table
DECLARE @StartDate DATE = (SELECT MIN(sales_date) FROM sales);
DECLARE @EndDate DATE = (SELECT MAX(sales_date) FROM sales);

-- Step 2 & 3: Use a recursive CTE to generate all weeks and then find the missing ones
;WITH GeneratedWeeks AS (
    -- Anchor member: Start the sequence with the first sales date
    SELECT @StartDate AS week_date
    UNION ALL
    -- Recursive member: Add one week to the previous date
    SELECT
        DATEADD(week, 1, week_date)
    FROM
        GeneratedWeeks
    -- Termination condition: Stop when the next date would exceed the end date
    WHERE
        DATEADD(week, 1, week_date) < @EndDate
)
-- Use EXCEPT to find what's in our generated list but not in the real table
SELECT week_date AS missing_week_date FROM GeneratedWeeks
EXCEPT
SELECT sales_date FROM sales;
```
