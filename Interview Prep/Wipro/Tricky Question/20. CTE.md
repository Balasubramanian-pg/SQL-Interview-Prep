## 20. Explain **CTE (Common Table Expressions)** vs **temporary tables**, and when to use each.

![1_3gwP8b_TC2jQXC7KorZZWA](https://github.com/user-attachments/assets/8bb0685a-2e7a-48a0-be61-ab0bf7786105)

## **1. Common Table Expressions (CTEs)**
### **What is a CTE?**
- A **temporary result set** defined within a SQL query using the `WITH` clause.
- Exists **only during the execution of the query**.
- Can be referenced **multiple times** in the same query.

### **Syntax Example**
```sql
WITH SalesCTE AS (
    SELECT customer_id, SUM(amount) AS total_spent
    FROM orders
    WHERE order_date > '2025-01-01'
    GROUP BY customer_id
)
SELECT * FROM SalesCTE WHERE total_spent > 1000;
```

### **Pros**
- **Readability**: Makes complex queries easier to understand.
- **Encapsulation**: Isolates logic for reuse in the same query.
- **No storage overhead**: Disappears after query execution.

### **Cons**
- **Not persistent**: Cannot be reused across queries.
- **Performance**: May not be optimized as well as temporary tables for large datasets.

## **2. Temporary Tables**
### **What is a Temporary Table?**
- A **physical table** created for temporary use, stored in `tempdb` (or equivalent).
- Exists **for the duration of a session or transaction**.
- Can be indexed, altered, and queried like a regular table.

### **Syntax Example**
```sql
-- Create
CREATE TEMPORARY TABLE TempSales (
    customer_id INT,
    total_spent DECIMAL(10, 2)
);

-- Populate
INSERT INTO TempSales
SELECT customer_id, SUM(amount)
FROM orders
WHERE order_date > '2025-01-01'
GROUP BY customer_id;

-- Use
SELECT * FROM TempSales WHERE total_spent > 1000;

-- Drop (optional, often auto-dropped)
DROP TABLE TempSales;
```

### **Pros**
- **Persistent within session**: Can be reused across multiple queries.
- **Performance**: Can be indexed for faster access.
- **Flexibility**: Supports DML operations (INSERT, UPDATE, DELETE).

### **Cons**
- **Storage overhead**: Consumes disk space.
- **Maintenance**: Requires explicit creation, population, and cleanup.

## **CTE vs. Temporary Table: When to Use Each?**

| Feature                | **CTE**                                      | **Temporary Table**                     |
|------------------------|----------------------------------------------|-----------------------------------------|
| **Scope**              | Single query.                               | Session or transaction.                |
| **Storage**            | No physical storage.                        | Physical storage (disk).                |
| **Reusability**        | Only within the same query.                 | Across multiple queries in a session.  |
| **Performance**        | Optimized for small to medium datasets.     | Better for large datasets (indexable).  |
| **Syntax**             | Simple (`WITH` clause).                     | Requires CREATE/INSERT/DROP.            |
| **Use Case**           | Simplifying complex queries.               | Storing intermediate results for reuse. |

### **Key Callouts**

<ins>**Callout 1: Readability vs. Performance**</ins>
- Use **CTEs** for **clarity** in complex queries.
- Use **temporary tables** for **performance** with large datasets or repeated access.

<ins>**Callout 2: Session Persistence**</ins>
- **CTEs** disappear after the query ends.
- **Temporary tables** persist until the session ends or you drop them.

<ins>**Callout 3: Indexing**</ins>
- **Temporary tables** can be indexed for faster queries.
- **CTEs** cannot be indexed.

<ins>**Callout 4: Recursive Queries**</ins>
- **CTEs** support **recursive queries** (e.g., hierarchical data).
- **Temporary tables** do not natively support recursion.

<ins>**Callout 5: Overhead**</ins>
- **CTEs** have minimal overhead.
- **Temporary tables** require explicit cleanup and storage.

**When to Use Which?**
- **Use a CTE** for:
  - Simplifying a single complex query.
  - Recursive queries (e.g., organizational charts).
  - Avoiding physical storage.

- **Use a temporary table** for:
  - Storing intermediate results for multiple queries.
  - Large datasets requiring indexing.
  - Breaking down complex operations into steps.

**Example:**
- **CTE**: Analyzing sales data in a single report query.
- **Temporary Table**: Processing and transforming data in multiple steps before generating a final report.
