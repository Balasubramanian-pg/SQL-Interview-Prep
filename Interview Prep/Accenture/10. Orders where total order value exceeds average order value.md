# **10. Orders where total order value exceeds average order value**
Assume `OrderDetails(order_id, product_id, quantity, unit_price)`.

```sql
WITH OrderTotals AS (
    SELECT order_id, SUM(quantity * unit_price) AS total_value
    FROM OrderDetails
    GROUP BY order_id
)
SELECT *
FROM OrderTotals
WHERE total_value > (SELECT AVG(total_value) FROM OrderTotals);
```
## Business Value
Identifying high-value orders helps businesses:
- Recognize premium customers and purchasing patterns
- Optimize fulfillment processes for valuable orders
- Develop targeted upsell strategies
- Identify potential bulk buyers or resellers
- Improve customer segmentation and personalization

## Database Schema
```sql
CREATE TABLE OrderDetails (
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    PRIMARY KEY (order_id, product_id)
);

-- Optional complementary tables
CREATE TABLE Orders (
    order_id INT PRIMARY KEY,
    customer_id INT,
    order_date TIMESTAMP
);

CREATE TABLE Products (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(100)
);
```

## Enhanced SQL Solution

```sql
WITH OrderTotals AS (
    SELECT 
        order_id, 
        SUM(quantity * unit_price) AS total_value,
        COUNT(product_id) AS product_count
    FROM 
        OrderDetails
    GROUP BY 
        order_id
),
AverageOrder AS (
    SELECT 
        AVG(total_value) AS avg_order_value,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY total_value) AS median_order_value
    FROM 
        OrderTotals
)
SELECT 
    ot.order_id,
    ot.total_value,
    ot.product_count,
    ao.avg_order_value,
    ao.median_order_value,
    ROUND((ot.total_value - ao.avg_order_value) / ao.avg_order_value * 100, 2) AS pct_above_avg,
    CASE 
        WHEN ot.total_value > 2 * ao.avg_order_value THEN 'Premium'
        WHEN ot.total_value > ao.avg_order_value THEN 'Above Average'
        ELSE 'Standard'
    END AS order_segment
FROM 
    OrderTotals ot
CROSS JOIN 
    AverageOrder ao
WHERE 
    ot.total_value > ao.avg_order_value
ORDER BY 
    ot.total_value DESC;
```

## Key Enhancements

1. **Added Business Metrics**:
   - `median_order_value`: Less sensitive to outliers than average
   - `pct_above_avg`: Quantifies how much each order exceeds the average
   - `order_segment`: Classifies orders into meaningful categories

2. **Contextual Information**:
   - Included product count per order
   - Added comparative metrics in results

3. **Improved Analysis**:
   - Added sorting by total value (highest first)
   - Calculated percentage difference from average

## Sample Results

| order_id | total_value | product_count | avg_order_value | median_order_value | pct_above_avg | order_segment |
|----------|-------------|---------------|-----------------|--------------------|---------------|---------------|
| 10482    | 589.50      | 7             | 125.25          | 98.75              | 370.66%       | Premium       |
| 10477    | 325.00      | 4             | 125.25          | 98.75              | 159.48%       | Above Average |
| 10465    | 265.25      | 5             | 125.25          | 98.75              | 111.78%       | Above Average |

## Alternative Approaches

1. **Using Window Functions**:
```sql
SELECT 
    order_id,
    total_value,
    avg_order_value
FROM (
    SELECT 
        order_id,
        SUM(quantity * unit_price) AS total_value,
        AVG(SUM(quantity * unit_price)) OVER() AS avg_order_value
    FROM 
        OrderDetails
    GROUP BY 
        order_id
) t
WHERE 
    total_value > avg_order_value;
```

2. **Top N High-Value Orders**:
```sql
WITH OrderTotals AS (
    SELECT 
        order_id, 
        SUM(quantity * unit_price) AS total_value
    FROM 
        OrderDetails
    GROUP BY 
        order_id
)
SELECT 
    order_id,
    total_value
FROM 
    OrderTotals
ORDER BY 
    total_value DESC
LIMIT 50;
```

3. **Customer-Level Analysis**:
```sql
WITH CustomerOrderStats AS (
    SELECT 
        o.customer_id,
        SUM(od.quantity * od.unit_price) AS total_value,
        COUNT(DISTINCT o.order_id) AS order_count
    FROM 
        Orders o
    JOIN 
        OrderDetails od ON o.order_id = od.order_id
    GROUP BY 
        o.customer_id
)
SELECT 
    customer_id,
    total_value,
    order_count,
    total_value / order_count AS avg_order_value
FROM 
    CustomerOrderStats
WHERE 
    total_value / order_count > (
        SELECT AVG(total_value / order_count) 
        FROM CustomerOrderStats
    );
```

## Performance Optimization

1. **Indexing Strategy**:
```sql
CREATE INDEX idx_orderdetails_order ON OrderDetails(order_id);
CREATE INDEX idx_orderdetails_value ON OrderDetails(order_id, (quantity * unit_price));
```

2. **Materialized View for Frequent Analysis**:
```sql
CREATE MATERIALIZED VIEW mv_high_value_orders AS
WITH OrderTotals AS (
    SELECT order_id, SUM(quantity * unit_price) AS total_value
    FROM OrderDetails
    GROUP BY order_id
)
SELECT * FROM OrderTotals
WHERE total_value > (SELECT AVG(total_value) FROM OrderTotals);
```

## Business Applications

1. **Customer Service Prioritization**:
   - Flag high-value orders for special handling
   - Proactive communication for premium orders

2. **Marketing Strategy**:
   - Target customers with high order values for loyalty programs
   - Create special offers for customers near the premium threshold

3. **Inventory Management**:
   - Ensure stock availability for frequently ordered high-value items
   - Identify products commonly purchased together in high-value orders

4. **Pricing Strategy**:
   - Analyze price sensitivity of high-value customers
   - Identify opportunities for premium product bundles

## Extended Analysis

1. **Time-Based High-Value Trends**:
```sql
WITH DailyHighValueOrders AS (
    SELECT 
        DATE(o.order_date) AS order_day,
        COUNT(*) AS high_value_orders,
        AVG(od.total_value) AS avg_high_value
    FROM 
        Orders o
    JOIN (
        SELECT 
            order_id, 
            SUM(quantity * unit_price) AS total_value
        FROM 
            OrderDetails
        GROUP BY 
            order_id
    ) od ON o.order_id = od.order_id
    WHERE 
        od.total_value > (SELECT AVG(total_value) FROM (
            SELECT SUM(quantity * unit_price) AS total_value
            FROM OrderDetails
            GROUP BY order_id
        ) t)
    GROUP BY 
        DATE(o.order_date)
)
SELECT 
    order_day,
    high_value_orders,
    avg_high_value,
    AVG(high_value_orders) OVER(ORDER BY order_day ROWS 6 PRECEDING) AS weekly_avg
FROM 
    DailyHighValueOrders
ORDER BY 
    order_day;
```

2. **Product Composition Analysis**:
```sql
WITH HighValueOrders AS (
    SELECT DISTINCT order_id
    FROM (
        SELECT 
            order_id, 
            SUM(quantity * unit_price) AS total_value
        FROM 
            OrderDetails
        GROUP BY 
            order_id
        HAVING 
            SUM(quantity * unit_price) > (
                SELECT AVG(total_value) FROM (
                    SELECT SUM(quantity * unit_price) AS total_value
                    FROM OrderDetails
                    GROUP BY order_id
                ) t
            )
    ) hvo
)
SELECT 
    p.product_name,
    COUNT(*) AS occurrence_count,
    SUM(od.quantity) AS total_units_sold
FROM 
    OrderDetails od
JOIN 
    Products p ON od.product_id = p.product_id
WHERE 
    od.order_id IN (SELECT order_id FROM HighValueOrders)
GROUP BY 
    p.product_name
ORDER BY 
    occurrence_count DESC;
```
We compute each orderâ€™s total, then filter those above the overall average.
