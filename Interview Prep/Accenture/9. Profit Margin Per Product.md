# **9. Profit margin per product, ranked within category**
Assume `Products(product_id, category_id, cost_price, selling_price)`.

```sql
SELECT category_id, 
       product_id,
       (selling_price - cost_price) / selling_price * 100 AS profit_margin,
       RANK() OVER(PARTITION BY category_id ORDER BY (selling_price - cost_price) / selling_price DESC) AS rnk
FROM Products;
```
## Business Value
Understanding profit margins by category helps businesses:
- Identify high-margin products to promote
- Spot underperforming products needing repricing
- Optimize category-level profitability
- Make informed procurement decisions
- Develop targeted marketing strategies

## Database Schema
```sql
CREATE TABLE Products (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(100) NOT NULL,
    category_id INT NOT NULL,
    cost_price DECIMAL(10,2) NOT NULL,
    selling_price DECIMAL(10,2) NOT NULL,
    stock_quantity INT,
    -- Additional product attributes
    supplier_id INT
);

CREATE TABLE Categories (
    category_id INT PRIMARY KEY,
    category_name VARCHAR(50) NOT NULL,
    department VARCHAR(50)
);
```

## Enhanced SQL Solution

```sql
WITH ProductMargins AS (
    SELECT 
        p.category_id,
        c.category_name,
        p.product_id,
        p.product_name,
        p.cost_price,
        p.selling_price,
        (p.selling_price - p.cost_price) AS profit_amount,
        ROUND((p.selling_price - p.cost_price) / p.selling_price * 100, 2) AS profit_margin_pct,
        RANK() OVER(
            PARTITION BY p.category_id 
            ORDER BY (p.selling_price - p.cost_price) / p.selling_price DESC
        ) AS margin_rank,
        DENSE_RANK() OVER(
            PARTITION BY p.category_id 
            ORDER BY (p.selling_price - p.cost_price) DESC
        ) AS profit_amount_rank
    FROM 
        Products p
    JOIN 
        Categories c ON p.category_id = c.category_id
    WHERE 
        p.selling_price > 0 -- Avoid division by zero
)
SELECT 
    category_id,
    category_name,
    product_id,
    product_name,
    cost_price,
    selling_price,
    profit_amount,
    profit_margin_pct || '%' AS profit_margin,
    margin_rank,
    profit_amount_rank,
    CASE 
        WHEN profit_margin_pct > 50 THEN 'Premium'
        WHEN profit_margin_pct > 30 THEN 'High'
        WHEN profit_margin_pct > 15 THEN 'Medium'
        ELSE 'Low'
    END AS margin_segment
FROM 
    ProductMargins
ORDER BY 
    category_name,
    margin_rank;
```

## Key Enhancements

1. **Added Business Metrics**:
   - `profit_amount`: Absolute profit value
   - `profit_amount_rank`: Ranking by dollar profit
   - `margin_segment`: Categorical classification

2. **Improved Readability**:
   - Included product and category names
   - Formatted percentage with % symbol
   - Rounded decimal places

3. **Additional Analysis Dimensions**:
   - Dual ranking by both margin % and absolute profit
   - Segment classification for easier analysis

4. **Data Quality Check**:
   - Added safeguard against division by zero

## Sample Results

| category_id | category_name | product_id | product_name | cost_price | selling_price | profit_amount | profit_margin | margin_rank | profit_amount_rank | margin_segment |
|-------------|---------------|------------|--------------|------------|---------------|---------------|---------------|-------------|--------------------|----------------|
| 101         | Electronics   | 2056       | Wireless Earbuds | 35.00     | 99.99         | 64.99         | 65.00%        | 1           | 1                  | Premium        |
| 101         | Electronics   | 2057       | Bluetooth Speaker | 45.00    | 89.99         | 44.99         | 50.01%        | 2           | 2                  | Premium        |
| 102         | Grocery       | 3078       | Organic Coffee | 8.50      | 14.99         | 6.49          | 43.30%        | 1           | 1                  | High           |

## Alternative Approaches

1. **Top N Products Per Category**:
```sql
SELECT * FROM (
    -- Previous query as subquery
) t
WHERE margin_rank <= 3;
```

2. **Margin Distribution Analysis**:
```sql
SELECT 
    category_name,
    AVG(profit_margin_pct) AS avg_margin,
    MIN(profit_margin_pct) AS min_margin,
    MAX(profit_margin_pct) AS max_margin,
    STDDEV(profit_margin_pct) AS margin_stddev
FROM 
    ProductMargins
GROUP BY 
    category_name;
```

3. **Price Elasticity Consideration**:
```sql
SELECT 
    p.category_id,
    p.product_id,
    p.profit_margin_pct,
    s.units_sold,
    (p.profit_margin_pct * s.units_sold) AS total_profit_contribution
FROM 
    ProductMargins p
JOIN 
    (SELECT product_id, SUM(quantity) AS units_sold 
     FROM OrderDetails GROUP BY product_id) s
    ON p.product_id = s.product_id
ORDER BY 
    total_profit_contribution DESC;
```

## Performance Optimization

1. **Indexing Strategy**:
```sql
CREATE INDEX idx_products_category ON Products(category_id);
CREATE INDEX idx_products_pricing ON Products(cost_price, selling_price);
```

2. **Materialized View for Frequent Reports**:
```sql
CREATE MATERIALIZED VIEW mv_product_margins AS
-- Our main query here
WITH REFRESH EVERY 1 WEEK;
```

## Business Applications

1. **Pricing Strategy**:
   - Identify opportunities to increase prices on high-demand, high-margin products
   - Consider discounts on low-margin products to drive volume

2. **Product Assortment Planning**:
   - Expand offerings in high-margin categories
   - Review low-margin products for potential discontinuation

3. **Procurement Negotiations**:
   - Focus cost reduction efforts on high-volume, medium-margin products
   - Leverage margin data in supplier negotiations

4. **Marketing Focus**:
   - Highlight high-margin products in promotions
   - Create bundles combining high and low margin items

## Extended Analysis

1. **Margin Trends Over Time**:
```sql
WITH HistoricalMargins AS (
    SELECT 
        p.product_id,
        DATE_TRUNC('month', ph.effective_date) AS month,
        (ph.selling_price - ph.cost_price) / ph.selling_price AS margin_pct
    FROM 
        ProductPriceHistory ph
    JOIN 
        Products p ON ph.product_id = p.product_id
)
SELECT 
    p.category_id,
    p.product_name,
    hm.month,
    hm.margin_pct,
    LAG(hm.margin_pct, 1) OVER(PARTITION BY p.product_id ORDER BY hm.month) AS prev_margin
FROM 
    HistoricalMargins hm
JOIN 
    Products p ON hm.product_id = p.product_id
ORDER BY 
    p.category_id, p.product_id, hm.month;
```

2. **Category Health Dashboard**:
```sql
SELECT 
    c.category_name,
    COUNT(p.product_id) AS product_count,
    AVG(pm.profit_margin_pct) AS avg_margin,
    SUM(pm.profit_margin_pct * p.stock_quantity) / SUM(p.stock_quantity) AS weighted_margin,
    SUM(p.selling_price * p.stock_quantity) AS potential_revenue
FROM 
    Products p
JOIN 
    ProductMargins pm ON p.product_id = pm.product_id
JOIN 
    Categories c ON p.category_id = c.category_id
GROUP BY 
    c.category_name
ORDER BY 
    weighted_margin DESC;
```

3. **Supplier Performance Analysis**:
```sql
SELECT 
    s.supplier_name,
    COUNT(p.product_id) AS products_supplied,
    AVG(pm.profit_margin_pct) AS avg_margin,
    SUM(pm.profit_amount * od.quantity) AS total_profit_generated
FROM 
    Products p
JOIN 
    ProductMargins pm ON p.product_id = pm.product_id
JOIN 
    Suppliers s ON p.supplier_id = s.supplier_id
LEFT JOIN 
    OrderDetails od ON p.product_id = od.product_id
GROUP BY 
    s.supplier_name
ORDER BY 
    total_profit_generated DESC;
```
