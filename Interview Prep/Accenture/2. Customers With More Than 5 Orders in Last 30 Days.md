# Customers with More Than 5 Orders in the Last 30 Days

## Business Context
Identifying high-frequency customers helps businesses:
- Reward loyal customers with special offers
- Identify potential bulk buyers or resellers
- Optimize inventory for frequent purchasers
- Detect potential fraudulent activity (unusually high order volumes)

## Database Schema

```sql
CREATE TABLE Orders (
    order_id INT PRIMARY KEY,
    customer_id INT NOT NULL,
    order_date DATE NOT NULL
    -- Additional order attributes could be included
);
```

**Table Structure:**
- `order_id`: Unique identifier for each order
- `customer_id`: Identifier linking to the customer
- `order_date`: Date when the order was placed (critical for this analysis)

## Sample Data

| order_id | customer_id | order_date  |
|----------|-------------|-------------|
| 1001     | 101         | 2023-06-01  |
| 1002     | 101         | 2023-06-05  |
| 1003     | 101         | 2023-06-10  |
| 1004     | 101         | 2023-06-15  |
| 1005     | 101         | 2023-06-20  |
| 1006     | 101         | 2023-06-25  |
| 1007     | 102         | 2023-06-03  |
| 1008     | 102         | 2023-06-04  |
| 1009     | 103         | 2023-05-28  | -- Outside 30-day window
| 1010     | 103         | 2023-06-10  |
| 1011     | 103         | 2023-06-15  |

## SQL Solution

```sql
SELECT 
    customer_id, 
    COUNT(*) AS order_count
FROM 
    Orders
WHERE 
    order_date >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY 
    customer_id
HAVING 
    COUNT(*) > 5
ORDER BY 
    order_count DESC;
```

## Solution Breakdown

1. **Date Filtering**:
   - `WHERE order_date >= CURRENT_DATE - INTERVAL '30 days'` restricts analysis to recent activity
   - Uses the current date as reference point for dynamic calculation

2. **Aggregation**:
   - `GROUP BY customer_id` creates groups for each customer
   - `COUNT(*)` calculates total orders per customer

3. **Threshold Filter**:
   - `HAVING COUNT(*) > 5` excludes customers with 5 or fewer orders
   - HAVING (vs WHERE) because it filters on aggregate results

4. **Sorting** (added value):
   - `ORDER BY order_count DESC` shows most active customers first

## Expected Results

With the sample data (assuming CURRENT_DATE = 2023-06-28):

| customer_id | order_count |
|-------------|-------------|
| 101         | 6           |

**Interpretation**:
- Customer 101 placed 6 orders in the period (meets our >5 threshold)
- Customer 102 had only 2 orders (excluded)
- Customer 103 had 2 orders within window (1 order was too old)

## Alternative Approaches

1. **With Customer Details** (if joining with Customers table):
   ```sql
   SELECT 
       o.customer_id, 
       c.name, 
       c.email,
       COUNT(*) AS order_count
   FROM 
       Orders o
   JOIN 
       Customers c ON o.customer_id = c.customer_id
   WHERE 
       o.order_date >= CURRENT_DATE - INTERVAL '30 days'
   GROUP BY 
       o.customer_id, c.name, c.email
   HAVING 
       COUNT(*) > 5;
   ```

2. **Using Window Functions** (for more complex analysis):
   ```sql
   WITH CustomerOrderCounts AS (
       SELECT 
           customer_id,
           COUNT(*) OVER (
               PARTITION BY customer_id
               ORDER BY order_date
               RANGE BETWEEN INTERVAL '30 days' PRECEDING AND CURRENT ROW
           ) AS rolling_order_count
       FROM Orders
   )
   SELECT DISTINCT customer_id
   FROM CustomerOrderCounts
   WHERE rolling_order_count > 5;
   ```

## Performance Optimization

1. **Indexing Strategy**:
   ```sql
   CREATE INDEX idx_orders_customer_date ON Orders(customer_id, order_date);
   ```

2. **Date Calculation Options**:
   - PostgreSQL: `CURRENT_DATE - INTERVAL '30 days'`
   - MySQL: `DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)`
   - SQL Server: `DATEADD(day, -30, GETDATE())`

## Business Applications

1. **Loyalty Programs**:
   - Identify candidates for VIP status or special rewards
   - Offer exclusive benefits to frequent buyers

2. **Customer Support**:
   - Prioritize support for high-value customers
   - Proactive outreach to understand their needs

3. **Fraud Detection**:
   - Investigate unusually high order volumes
   - Verify legitimate bulk purchases vs potential abuse

4. **Marketing Strategy**:
   - Analyze what drives frequent purchases
   - Replicate successful patterns with other customers

## Extended Analysis

1. **Including Order Value**:
   ```sql
   SELECT 
       customer_id,
       COUNT(*) AS order_count,
       SUM(amount) AS total_spent
   FROM Orders
   WHERE order_date >= CURRENT_DATE - INTERVAL '30 days'
   GROUP BY customer_id
   HAVING COUNT(*) > 5
   ORDER BY total_spent DESC;
   ```

2. **Trend Analysis**:
   ```sql
   SELECT 
       customer_id,
       COUNT(*) AS current_period_orders,
       (SELECT COUNT(*) 
        FROM Orders 
        WHERE customer_id = o.customer_id
        AND order_date BETWEEN CURRENT_DATE - INTERVAL '60 days' 
                           AND CURRENT_DATE - INTERVAL '30 days'
       ) AS previous_period_orders
   FROM Orders o
   WHERE order_date >= CURRENT_DATE - INTERVAL '30 days'
   GROUP BY customer_id
   HAVING COUNT(*) > 5;
   ```

3. **Order Frequency Analysis**:
   ```sql
   SELECT 
       customer_id,
       COUNT(*) AS order_count,
       ROUND(30.0/COUNT(*), 2) AS days_between_orders
   FROM Orders
   WHERE order_date >= CURRENT_DATE - INTERVAL '30 days'
   GROUP BY customer_id
   HAVING COUNT(*) > 5;
   ```
